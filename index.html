<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Student Picker - Firebase</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font for Khmer Language (Google Fonts) -->
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM & Babel -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "firebase/app": "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js",
                "firebase/database": "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js",
                "lucide-react": "https://esm.sh/lucide-react@0.378.0"
            }
        }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05); 
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2); 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3); 
        }
        .no-select {
            -webkit-user-select: none;
            user-select: none;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.5); border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously } from 'firebase/auth';
        import { 
            getFirestore, 
            collectionGroup, 
            getDocs, 
            query, 
            where, 
            limit 
        } from 'firebase/firestore';
        // Updated Imports for Firebase Database
        import { getDatabase, ref, update, onValue, push, set, remove } from 'firebase/database';
        import { 
            Users, Shuffle, RefreshCw, Trophy, UserCircle, 
            Settings, AlertTriangle, Database, Clock, 
            Calendar, CheckCircle2, Send, X, Save, MessageSquare, 
            ToggleLeft, ToggleRight, UserMinus, RotateCcw, Cloud,
            Eye, EyeOff, Lock, Filter, Briefcase, Users as UsersIcon,
            UserCog, Search, Check, Ban, ListFilter, Plus, Trash2, Power,
            CheckSquare, Square
        } from 'lucide-react';

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCgc3fq9mDHMCjTRRHD3BPBL31JkKZgXFc",
            authDomain: "checkme-10e18.firebaseapp.com",
            databaseURL: "https://checkme-10e18-default-rtdb.firebaseio.com",
            projectId: "checkme-10e18",
            storageBucket: "checkme-10e18.firebasestorage.app",
            messagingSenderId: "1030447497157",
            appId: "1:1030447497157:web:9792086df1e864559fd5ac",
            measurementId: "G-QCJ2JH4WH6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        // --- Helpers ---
        const getTodayDateStr = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const getCurrentShift = () => {
            const hour = new Date().getHours();
            if (hour >= 6 && hour < 12) return "·ûú·üÅ·ûì·ûñ·üí·ûö·ûπ·ûÄ"; 
            if (hour >= 12 && hour < 17) return "·ûú·üÅ·ûì·ûö·ûü·üÄ·ûõ"; 
            if (hour >= 17) return "·ûú·üÅ·ûì·ûô·ûî·üã"; 
            return "·ûÄ·üí·ûö·üÖ·ûò·üâ·üÑ·ûÑ";
        };

        // Helper to normalize strings for comparison (remove spaces, lowercase)
        const normalizeStr = (str) => {
            return (str || '').toLowerCase().replace(/[\s_-]+/g, '');
        };

        // --- Main Component ---
        const RandomStudentApp = () => {
            const [allStudents, setAllStudents] = useState([]); 
            const [playableStudents, setPlayableStudents] = useState([]); 
            
            const [currentName, setCurrentName] = useState("·ûè·üí·ûö·üÄ·ûò·ûÅ·üí·ûõ·ûΩ·ûì...");
            const [winner, setWinner] = useState(null);
            const [isSpinning, setIsSpinning] = useState(false);
            const [loading, setLoading] = useState(true);
            const [useDemoData, setUseDemoData] = useState(false);
            const [error, setError] = useState(null);
            const [debugInfo, setDebugInfo] = useState("");
            const [sendingTelegram, setSendingTelegram] = useState(false);
            const [manualSendVisible, setManualSendVisible] = useState(false);

            // --- Settings State ---
            const [showSettings, setShowSettings] = useState(false);
            const [showStudentList, setShowStudentList] = useState(false);
            
            const [botToken, setBotToken] = useState("");
            
            // Updated: telegramChannels instead of single chatId
            const [telegramChannels, setTelegramChannels] = useState([]); 
            
            const [customMessage, setCustomMessage] = useState("");
            
            // Core Settings
            const [autoSendTelegram, setAutoSendTelegram] = useState(true);
            const [filterUniqueWinners, setFilterUniqueWinners] = useState(false);
            const [todaysWinners, setTodaysWinners] = useState([]);
            
            // Global Filters
            const [filterDeptTraining, setFilterDeptTraining] = useState(false);
            const [filterDeptITGen2, setFilterDeptITGen2] = useState(false);
            const [filterDeptAssistant, setFilterDeptAssistant] = useState(false); // NEW FILTER
            const [filterGroupITSupport, setFilterGroupITSupport] = useState(false);
            const [filterGroupDRB, setFilterGroupDRB] = useState(false);

            // Student List Modal Filters
            const [listFilterDept, setListFilterDept] = useState('All');
            const [listFilterGroup, setListFilterGroup] = useState('All');
            const [studentSearchTerm, setStudentSearchTerm] = useState("");

            // Excluded Students
            const [excludedNames, setExcludedNames] = useState([]); 

            const [isSaving, setIsSaving] = useState(false);
            const [showBotToken, setShowBotToken] = useState(false);
            const [settingsLoaded, setSettingsLoaded] = useState(false);

            const intervalRef = useRef(null);

            // --- 1. Load Settings from Realtime Database ---
            useEffect(() => {
                const settingsRef = ref(rtdb, 'settings/appConfig');
                
                const unsubscribe = onValue(settingsRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        if (data.botToken) setBotToken(data.botToken);
                        if (data.customMessage) setCustomMessage(data.customMessage);
                        if (data.autoSendTelegram !== undefined) setAutoSendTelegram(data.autoSendTelegram);
                        if (data.filterUniqueWinners !== undefined) setFilterUniqueWinners(data.filterUniqueWinners);
                        
                        // Load Channels
                        if (data.telegramChannels && Array.isArray(data.telegramChannels)) {
                            setTelegramChannels(data.telegramChannels);
                        } else if (data.chatId) {
                            setTelegramChannels([
                                { id: 'default', name: 'Default Group', chatId: data.chatId, active: true }
                            ]);
                        } else {
                            setTelegramChannels([]);
                        }
                        
                        // Load Filters
                        if (data.filterDeptTraining !== undefined) setFilterDeptTraining(data.filterDeptTraining);
                        if (data.filterDeptITGen2 !== undefined) setFilterDeptITGen2(data.filterDeptITGen2);
                        if (data.filterDeptAssistant !== undefined) setFilterDeptAssistant(data.filterDeptAssistant); // NEW LOAD
                        if (data.filterGroupITSupport !== undefined) setFilterGroupITSupport(data.filterGroupITSupport);
                        if (data.filterGroupDRB !== undefined) setFilterGroupDRB(data.filterGroupDRB);
                        
                        // Load Excluded Names
                        if (data.excludedNames) {
                            const names = Array.isArray(data.excludedNames) ? data.excludedNames : Object.values(data.excludedNames || {});
                            setExcludedNames(names);
                        } else {
                            setExcludedNames([]);
                        }
                    }
                    setSettingsLoaded(true);
                });

                return () => unsubscribe();
            }, []);

            // --- 2. Load Public Today's Winners from DB ---
            useEffect(() => {
                const winnersRef = ref(rtdb, `daily_winners/${getTodayDateStr()}`);
                
                const unsubscribe = onValue(winnersRef, (snapshot) => {
                    const data = snapshot.val();
                    const winnersList = data ? Object.values(data) : [];
                    setTodaysWinners(winnersList);
                });

                return () => unsubscribe();
            }, []);

            // --- PLAYABLE LIST LOGIC (Global Filtering for Spin) ---
            useEffect(() => {
                let filtered = allStudents;

                // 1. Exclude Manually Disabled
                if (excludedNames.length > 0) {
                    filtered = filtered.filter(s => !excludedNames.includes(s.name));
                }

                // 2. Exclude Today's Winners
                if (filterUniqueWinners) {
                    filtered = filtered.filter(s => !todaysWinners.includes(s.name));
                }

                // 3. Department Filters
                const activeDeptFilters = [];
                if (filterDeptTraining) activeDeptFilters.push("Training"); 
                if (filterDeptITGen2) activeDeptFilters.push("·ûá·üÜ·ûì·û∂·ûì·üã·ü¢");
                
                // IMPORTANT FIX: Use specific string to avoid matching "Training_·ûá·üÜ·ûì·ûΩ·ûô·ûÄ·û∂·ûö..."
                if (filterDeptAssistant) activeDeptFilters.push("·ûá·üÜ·ûì·ûΩ·ûô·ûÄ·û∂·ûö_·ûõ·üÑ·ûÄ·ûÇ·üí·ûö·ûº·ûä·û∂·ûö·üâ·ûº"); 
                
                if (activeDeptFilters.length > 0) {
                    filtered = filtered.filter(s => {
                        const sDept = (s.department || '').toLowerCase();
                        return activeDeptFilters.some(f => sDept.includes(f.toLowerCase()));
                    });
                }

                // 4. Group Filters (Enhanced Robust Match)
                const activeGroupFilters = [];
                if (filterGroupITSupport) activeGroupFilters.push("IT Support");
                if (filterGroupDRB) activeGroupFilters.push("DRB");

                if (activeGroupFilters.length > 0) {
                    filtered = filtered.filter(s => {
                        // Check both Group AND Department fields for the keyword
                        // Normalize by removing all spaces and converting to lowercase
                        const groupRaw = (s.group || '').toLowerCase() + " " + (s.department || '').toLowerCase();
                        const groupNormalized = groupRaw.replace(/[\s_-]+/g, '');
                        
                        return activeGroupFilters.some(filterLabel => {
                            if (filterLabel === "IT Support") {
                                // Match "itsupport" (normalized)
                                return groupNormalized.includes("itsupport");
                            }
                            if (filterLabel === "DRB") {
                                return groupNormalized.includes("drb");
                            }
                            return false;
                        });
                    });
                }

                setPlayableStudents(filtered);
            }, [
                allStudents, 
                excludedNames,
                filterUniqueWinners, 
                todaysWinners, 
                filterDeptTraining, 
                filterDeptITGen2,
                filterDeptAssistant,
                filterGroupITSupport, 
                filterGroupDRB
            ]);

            // --- UPDATE SETTINGS ---
            const updateSetting = async (updates) => {
                try {
                    await update(ref(rtdb, 'settings/appConfig'), {
                        ...updates,
                        updatedAt: new Date().toISOString()
                    });
                } catch (err) {
                    console.error("Error updating setting:", err);
                }
            };

            const handleSaveSettingsButton = async () => {
                setIsSaving(true);
                const cleanChannels = telegramChannels.filter(c => c.chatId.trim() !== "");
                
                await updateSetting({
                    botToken,
                    telegramChannels: cleanChannels,
                    customMessage,
                    autoSendTelegram,
                    filterUniqueWinners,
                    filterDeptTraining,
                    filterDeptITGen2,
                    filterDeptAssistant, 
                    filterGroupITSupport,
                    filterGroupDRB,
                    excludedNames
                });
                setTelegramChannels(cleanChannels);
                setIsSaving(false);
                setShowSettings(false);
            };

            // --- Channel Management Functions ---
            const addChannel = () => {
                setTelegramChannels([...telegramChannels, { id: Date.now().toString(), name: '', chatId: '', active: true }]);
            };

            const updateChannel = (id, field, value) => {
                setTelegramChannels(telegramChannels.map(c => c.id === id ? { ...c, [field]: value } : c));
            };

            const removeChannel = (id) => {
                setTelegramChannels(telegramChannels.filter(c => c.id !== id));
            };

            const toggleChannelActive = (id) => {
                setTelegramChannels(telegramChannels.map(c => c.id === id ? { ...c, active: !c.active } : c));
            };

            // Toggle Functions
            const toggleAutoSend = () => { const v = !autoSendTelegram; setAutoSendTelegram(v); updateSetting({ autoSendTelegram: v }); };
            const toggleFilterUnique = () => { const v = !filterUniqueWinners; setFilterUniqueWinners(v); updateSetting({ filterUniqueWinners: v }); };
            const toggleDeptTraining = () => { const v = !filterDeptTraining; setFilterDeptTraining(v); updateSetting({ filterDeptTraining: v }); };
            const toggleDeptITGen2 = () => { const v = !filterDeptITGen2; setFilterDeptITGen2(v); updateSetting({ filterDeptITGen2: v }); };
            const toggleDeptAssistant = () => { const v = !filterDeptAssistant; setFilterDeptAssistant(v); updateSetting({ filterDeptAssistant: v }); }; 
            const toggleGroupITSupport = () => { const v = !filterGroupITSupport; setFilterGroupITSupport(v); updateSetting({ filterGroupITSupport: v }); };
            const toggleGroupDRB = () => { const v = !filterGroupDRB; setFilterGroupDRB(v); updateSetting({ filterGroupDRB: v }); };

            const handleMessageBlur = () => { updateSetting({ customMessage }); };

            const toggleStudentExclusion = (studentName) => {
                let newExcluded;
                if (excludedNames.includes(studentName)) {
                    newExcluded = excludedNames.filter(name => name !== studentName);
                } else {
                    newExcluded = [...excludedNames, studentName];
                }
                setExcludedNames(newExcluded);
                updateSetting({ excludedNames: newExcluded });
            };

            // Toggle All Visible Students
            const toggleAllVisible = (enable) => {
                const visibleNames = displayedStudents.map(s => s.name);
                let newExcluded;

                if (enable) {
                    newExcluded = excludedNames.filter(name => !visibleNames.includes(name));
                } else {
                    const currentExcludedSet = new Set(excludedNames);
                    visibleNames.forEach(name => currentExcludedSet.add(name));
                    newExcluded = Array.from(currentExcludedSet);
                }

                setExcludedNames(newExcluded);
                updateSetting({ excludedNames: newExcluded });
            };

            const clearTodaysWinners = () => {
                if (window.confirm("·ûè·ûæ·û¢·üí·ûì·ûÄ·ûÖ·üí·ûî·û∂·ûü·üã·ûë·üÅ·ûê·û∂·ûÖ·ûÑ·üã·ûõ·ûª·ûî·ûî·üí·ûö·ûú·ûè·üí·ûè·û∑·û¢·üí·ûì·ûÄ·ûà·üí·ûì·üá·ûü·ûò·üí·ûö·û∂·ûî·üã·ûê·üí·ûÑ·üÉ·ûì·üÅ·üá (Public)?")) {
                    remove(ref(rtdb, `daily_winners/${getTodayDateStr()}`))
                        .then(() => console.log("Cleared public winners list"))
                        .catch(err => console.error("Error clearing winners:", err));
                }
            };

            // Telegram Sending
            const sendToTelegram = async (student) => {
                const cleanToken = botToken.trim();
                const activeChannels = telegramChannels.filter(c => c.active && c.chatId.trim() !== "");

                if (!cleanToken || activeChannels.length === 0) {
                    if (manualSendVisible) {
                        if (!cleanToken) alert("·ûü·ûº·ûò·ûî·ûâ·üí·ûÖ·ûº·ûõ Bot Token ·ûì·üÖ·ûÄ·üí·ûì·ûª·ûÑ Settings!");
                        else alert("·ûü·ûº·ûò·ûî·ûâ·üí·ûÖ·ûº·ûõ Chat ID ·ûì·û∑·ûÑ·ûî·ûæ·ûÄ·ûä·üÜ·ûé·ûæ·ûö·ûÄ·û∂·ûö (Active) ·ûô·üâ·û∂·ûÑ·û†·üÑ·ûÖ·ûé·û∂·ûü·üã·ûò·ûΩ·ûô!");
                    }
                    return;
                }
                
                setSendingTelegram(true);

                // --- GENDER ICON LOGIC ---
                let icon = 'ü§ç';
                const name = student.name || '';
                const g = (student.gender || '').trim(); 
                
                const femaleKeywords = [
                    '·ûü·üí·ûö·û∏', '·ûì·û∂·ûÑ', '·ûÄ·ûâ·üí·ûâ·û∂', '·ûí·û∏·ûè·û∂', '·ûë·üÅ·ûú·û∏', '·ûõ·ûÄ·üí·ûÅ·û∑·ûé·û∂', '·ûÖ·û∂·ûì·üã', '·ûé·û∂·ûú·û∏', 
                    '·ûí·û∂·ûö·û∏', '·ûò·üâ·û∂·ûõ·û∏', '·ûü·ûª·ûï·û∂', '·ûÄ·üÇ·ûú', '·ûö·üê·ûè·üí·ûì', '·ûò·û∂·ûõ·û∂', '·ûî·ûª·ûî·üí·ûï·û∂', '·ûü·üÑ·ûó·û∂', 
                    '·ûÄ·ûì·üí·ûì·û∑·ûä·üí·ûã·û∂', '·ûö·ûÖ·ûì·û∂', '·ûñ·û∑·ûü·û∏', '·ûú·ûè·üí·ûè·û∏', '·ûÖ·û∑·ûì·üí·ûè·û∂', '·ûö·üâ·û∂·ûì·û∏', '·ûõ·û∏·ûä·û∂', '·ûä·û∂·ûú·û∏', 
                    '·û¢·ûò·ûö·û∂', '·ûÄ·ûª·ûü·ûª·ûò·û∂', '·ûú·û∑·ûÖ·üí·ûÜ·û∑·ûÄ·û∂', '·ûä·û∂·ûõ·û∏·ûü', '·ûò·ûª·üÜ', '·ûï·ûõ·üí·ûõ·û∂', '·ûü·üÑ·ûó·üê·ûé'
                ];

                if (g === '·ûü·üí·ûö·û∏' || g.toLowerCase() === 'female' || g.toLowerCase() === 'f') {
                    icon = '‚ù§Ô∏è';
                } 
                else if (g === '·ûî·üí·ûö·ûª·ûü' || g.toLowerCase() === 'male' || g.toLowerCase() === 'm') {
                    icon = 'ü§ç';
                } 
                else {
                    if (femaleKeywords.some(k => name.includes(k))) {
                        icon = '‚ù§Ô∏è';
                    }
                }

                let message = `${icon}${name}`;
                if (customMessage) message += ` ${customMessage}`;

                const promises = activeChannels.map(channel => {
                    const url = `https://api.telegram.org/bot${cleanToken}/sendMessage`;
                    return fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ chat_id: channel.chatId.trim(), text: message })
                    })
                    .then(res => res.json())
                    .then(data => ({ channelName: channel.name, success: data.ok, error: data.description }));
                });

                try {
                    const results = await Promise.all(promises);
                    const failures = results.filter(r => !r.success);
                    if (failures.length === 0) {
                        console.log("Message sent to all active channels successfully!");
                        setManualSendVisible(false);

                        if (filterUniqueWinners) {
                            if (!todaysWinners.includes(student.name)) {
                                const winnersRef = ref(rtdb, `daily_winners/${getTodayDateStr()}`);
                                push(winnersRef, student.name);
                            }
                        }
                    } else {
                        console.error("Some messages failed:", failures);
                        setManualSendVisible(true);
                        if (manualSendVisible) {
                            alert(`·ûî·ûö·û∂·ûá·üê·ûô·ûÅ·üí·ûõ·üá:\n${failures.map(f => `- ${f.channelName || 'Unnamed'}: ${f.error}`).join('\n')}`);
                        }
                    }
                } catch (error) {
                    console.error("Network Error:", error);
                    setManualSendVisible(true); 
                    if (manualSendVisible) alert("·ûò·û∂·ûì·ûî·ûâ·üí·û†·û∂ Network ·ûò·û∑·ûì·û¢·û∂·ûÖ·ûó·üí·ûá·û∂·ûî·üã·ûë·üÖ Telegram ·ûî·û∂·ûì·ûë·üÅ·üî");
                } finally {
                    setSendingTelegram(false);
                }
            };

            // Fetch Students
            useEffect(() => {
                const fetchStudents = async () => {
                    setLoading(true);
                    setError(null);
                    setDebugInfo("");
                    
                    const todayStr = getTodayDateStr();
                    const currentShift = getCurrentShift();
                    
                    setDebugInfo(`·ûÄ·üÜ·ûñ·ûª·ûÑ·ûü·üí·ûú·üÇ·ûÑ·ûö·ûÄ: ·ûê·üí·ûÑ·üÉ·ûë·û∏ ${todayStr} | ·ûú·üÅ·ûì: ${currentShift}`);

                    try {
                        await signInAnonymously(auth);

                        const recordsQuery = query(
                            collectionGroup(db, 'records'),
                            where('date', '==', todayStr),
                            limit(100)
                        );

                        const querySnapshot = await getDocs(recordsQuery);
                        
                        const fetchedStudents = [];
                        const uniqueNames = new Set();
                        let totalRecordsFound = 0;

                        querySnapshot.forEach((doc) => {
                            totalRecordsFound++;
                            const data = doc.data();
                            const name = data.employeeName || data.name;
                            const studentShift = data.shift || "·ûñ·üÅ·ûâ·ûò·üâ·üÑ·ûÑ";
                            
                            const checkIn = data.checkIn;
                            const checkOut = data.checkOut;

                            if (!checkIn) return; 
                            const checkInStr = String(checkIn).trim();
                            if (checkInStr === "" || checkInStr === "_" || checkInStr === "·ûà·û∫") return;

                            if (checkOut) {
                                const checkOutStr = String(checkOut).trim();
                                if (checkOutStr !== "" && checkOutStr !== "_") { return; }
                            }

                            if (name && !uniqueNames.has(name)) {
                                const dbShiftLower = studentShift.toLowerCase();
                                let isMatch = false;

                                if (dbShiftLower.includes("·ûñ·üÅ·ûâ·ûò·üâ·üÑ·ûÑ") || dbShiftLower.includes("full")) { isMatch = true; } 
                                else if (currentShift === "·ûú·üÅ·ûì·ûñ·üí·ûö·ûπ·ûÄ" && (dbShiftLower.includes("·ûñ·üí·ûö·ûπ·ûÄ") || dbShiftLower.includes("morning") || dbShiftLower.includes("·ûò·ûΩ·ûô·ûñ·üí·ûö·ûπ·ûÄ"))) { isMatch = true; }
                                else if (currentShift === "·ûú·üÅ·ûì·ûö·ûü·üÄ·ûõ" && (dbShiftLower.includes("·ûö·ûü·üÄ·ûõ") || dbShiftLower.includes("afternoon") || dbShiftLower.includes("·ûò·ûΩ·ûô·ûö·ûü·üÄ·ûõ"))) { isMatch = true; }
                                else if (currentShift === "·ûú·üÅ·ûì·ûô·ûî·üã" && (dbShiftLower.includes("·ûô·ûî·üã") || dbShiftLower.includes("evening") || dbShiftLower.includes("night") || dbShiftLower.includes("·ûñ·üÅ·ûõ·ûô·ûî·üã"))) { isMatch = true; }
                                else if (studentShift === currentShift) { isMatch = true; }

                                if (isMatch) {
                                    uniqueNames.add(name);
                                    fetchedStudents.push({ 
                                        id: doc.id, 
                                        name: name, 
                                        gender: data.gender || 'N/A', 
                                        shift: studentShift,
                                        department: data.department || 'N/A',
                                        // Robust Group Fetching
                                        group: data.group || data.Group || 'N/A' 
                                    });
                                }
                            }
                        });

                        if (fetchedStudents.length > 0) {
                            setAllStudents(fetchedStudents); 
                            setUseDemoData(false);
                            setDebugInfo(`·ûö·ûÄ·ûÉ·ûæ·ûâ ${fetchedStudents.length} ·ûì·û∂·ûÄ·üã (·ûÄ·üÜ·ûñ·ûª·ûÑ·ûò·û∂·ûì·ûú·ûè·üí·ûè·ûò·û∂·ûì)·üî`);
                        } else {
                            console.warn(`No active students found.`);
                            let msg = "";
                            if (totalRecordsFound > 0) {
                                msg = `·ûò·û∂·ûì·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûê·üí·ûÑ·üÉ·ûì·üÅ·üá (${totalRecordsFound}) ·ûî·üâ·ûª·ûì·üí·ûè·üÇ·ûî·üí·ûö·û†·üÇ·ûõ·ûá·û∂·ûñ·ûΩ·ûÄ·ûÇ·üÅ "CheckOut" ·û¢·ûü·üã·û†·ûæ·ûô ·û¨ "·ûà·û∫" ·û¨·ûÅ·ûª·ûü·ûú·üÅ·ûì·üî`;
                            } else {
                                msg = `·ûò·û∑·ûì·ûò·û∂·ûì·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûü·ûò·üí·ûö·û∂·ûî·üã·ûê·üí·ûÑ·üÉ·ûì·üÅ·üá (${todayStr}) ·ûë·üÅ·üî`;
                            }
                            setError(msg);
                            setAllStudents([]);
                            setUseDemoData(false);
                        }

                    } catch (err) {
                        console.error("Firestore Error:", err);
                        let errorMsg = "·ûò·û∂·ûì·ûî·ûâ·üí·û†·û∂·ûÄ·üí·ûì·ûª·ûÑ·ûÄ·û∂·ûö·ûó·üí·ûá·û∂·ûî·üã·üî";
                        if (err.code === 'permission-denied') errorMsg = "·ûÇ·üí·ûò·û∂·ûì·ûü·û∑·ûë·üí·ûí·û∑ (Permission Denied)·üî";
                        else if (err.code === 'failed-precondition') errorMsg = "·ûè·üí·ûö·ûº·ûú·ûÄ·û∂·ûö·ûî·ûÑ·üí·ûÄ·ûæ·ûè Index·üî";
                        setError(errorMsg);
                        setAllStudents([]); 
                        setUseDemoData(false);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchStudents();
            }, []);

            const handleSpin = () => {
                if (playableStudents.length === 0 || isSpinning) return;

                setIsSpinning(true);
                setWinner(null);
                setSendingTelegram(false);
                setManualSendVisible(false);
                let counter = 0;
                
                const calculatedSpins = playableStudents.length * 3;
                const totalSpins = calculatedSpins > 60 ? calculatedSpins : 60;
                const speed = 50; 

                if (intervalRef.current) clearInterval(intervalRef.current);

                intervalRef.current = setInterval(() => {
                    const randomIndex = Math.floor(Math.random() * playableStudents.length);
                    setCurrentName(playableStudents[randomIndex].name);
                    counter++;

                    if (counter >= totalSpins) {
                        clearInterval(intervalRef.current);
                        finishSpin(playableStudents[randomIndex]);
                    }
                }, speed);
            };

            const finishSpin = async (selectedStudent) => {
                setIsSpinning(false);
                setWinner(selectedStudent);
                setCurrentName(selectedStudent.name);
                
                if (autoSendTelegram) {
                    await sendToTelegram(selectedStudent);
                } else {
                    setManualSendVisible(true);
                }
            };

            // --- VIEW LIST LOGIC (Local Filters for Modal) ---
            const getFilteredViewList = () => {
                return allStudents.filter(s => {
                    const matchesSearch = s.name.toLowerCase().includes(studentSearchTerm.toLowerCase());
                    
                    // Dept Filter
                    let matchesDept = true;
                    const sDept = (s.department || '').toLowerCase().trim();
                    if (listFilterDept === 'Training') matchesDept = sDept.includes('training');
                    else if (listFilterDept === 'Gen2') matchesDept = sDept.includes('·ûá·üÜ·ûì·û∂·ûì·üã·ü¢') || sDept.includes('gen2');
                    // IMPORTANT FIX: Specific keyword for list filter too
                    else if (listFilterDept === 'Assistant') matchesDept = sDept.includes('·ûá·üÜ·ûì·ûΩ·ûô·ûÄ·û∂·ûö_·ûõ·üÑ·ûÄ·ûÇ·üí·ûö·ûº·ûä·û∂·ûö·üâ·ûº'); 

                    // Group Filter (Robust)
                    let matchesGroup = true;
                    // Combine Group + Dept for list filter too, to match logic
                    const groupRaw = (s.group || '').toLowerCase() + " " + (s.department || '').toLowerCase();
                    const sGroupNormalized = groupRaw.replace(/[\s_-]+/g, ''); 
                    
                    if (listFilterGroup === 'IT') {
                        matchesGroup = sGroupNormalized.includes('itsupport');
                    }
                    else if (listFilterGroup === 'DRB') {
                        matchesGroup = sGroupNormalized.includes('drb');
                    }

                    return matchesSearch && matchesDept && matchesGroup;
                });
            };

            const displayedStudents = getFilteredViewList();

            const renderStudentListItem = (student) => {
                const isExcluded = excludedNames.includes(student.name);
                return (
                    <div key={student.name} className="flex items-center justify-between bg-slate-700/50 p-3 rounded-lg border border-slate-600/50">
                        <div className="flex items-center gap-3">
                            <div className={`w-8 h-8 rounded-full flex items-center justify-center ${isExcluded ? 'bg-slate-600 text-slate-400' : 'bg-indigo-500/20 text-indigo-300'}`}>
                                <UserCircle className="w-5 h-5" />
                            </div>
                            <div className="flex flex-col">
                                <span className={`text-sm font-medium ${isExcluded ? 'text-slate-400 line-through' : 'text-white'}`}>
                                    {student.name}
                                </span>
                                <span className="text-[10px] text-slate-400">
                                    {student.group} ‚Ä¢ {student.department}
                                </span>
                            </div>
                        </div>
                        <button 
                            onClick={() => toggleStudentExclusion(student.name)}
                            className={`w-10 h-6 rounded-full p-1 transition-colors duration-200 ease-in-out relative ${!isExcluded ? 'bg-green-500' : 'bg-slate-600'}`}
                        >
                            <div className={`bg-white w-4 h-4 rounded-full shadow-sm transform duration-200 ease-in-out ${!isExcluded ? 'translate-x-4' : 'translate-x-0'}`}></div>
                        </button>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-slate-900 text-slate-100 flex items-center justify-center p-4 relative font-sans">
                    
                    {/* Student List Modal */}
                    {showStudentList && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
                            <div className="bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-md h-[85vh] flex flex-col relative animate-in zoom-in-95 duration-200">
                                <div className="p-4 border-b border-slate-700 flex items-center justify-between bg-slate-800 rounded-t-2xl z-10">
                                    <h2 className="text-lg font-bold text-white flex items-center gap-2">
                                        <UserCog className="w-5 h-5 text-indigo-400" />
                                        ·ûî·ûâ·üí·ûá·û∏·ûà·üí·ûò·üÑ·üá ({displayedStudents.length}/{allStudents.length})
                                    </h2>
                                    <button onClick={() => setShowStudentList(false)} className="text-slate-400 hover:text-white p-1">
                                        <X className="w-6 h-6" />
                                    </button>
                                </div>
                                
                                <div className="p-3 bg-slate-800/95 sticky top-0 z-10 border-b border-slate-700/50 space-y-3">
                                    {/* Search */}
                                    <div className="relative">
                                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400" />
                                        <input 
                                            type="text" 
                                            placeholder="·ûü·üí·ûú·üÇ·ûÑ·ûö·ûÄ·ûà·üí·ûò·üÑ·üá..." 
                                            value={studentSearchTerm}
                                            onChange={(e) => setStudentSearchTerm(e.target.value)}
                                            className="w-full bg-slate-900 border border-slate-600 rounded-lg py-2 pl-9 pr-4 text-sm text-white focus:outline-none focus:border-indigo-500"
                                        />
                                    </div>

                                    {/* Filters Bar */}
                                    <div className="flex flex-col gap-2">
                                        <div className="flex items-center gap-2 overflow-x-auto pb-1 no-scrollbar">
                                            <span className="text-[10px] text-slate-400 whitespace-nowrap flex items-center gap-1"><Briefcase className="w-3 h-3"/> ·ûï·üí·ûì·üÇ·ûÄ:</span>
                                            <button onClick={() => setListFilterDept('All')} className={`px-2 py-1 rounded text-[10px] whitespace-nowrap border ${listFilterDept === 'All' ? 'bg-indigo-600 border-indigo-600 text-white' : 'border-slate-600 text-slate-300'}`}>·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã</button>
                                            <button onClick={() => setListFilterDept('Training')} className={`px-2 py-1 rounded text-[10px] whitespace-nowrap border ${listFilterDept === 'Training' ? 'bg-orange-600 border-orange-600 text-white' : 'border-slate-600 text-slate-300'}`}>Training</button>
                                            <button onClick={() => setListFilterDept('Gen2')} className={`px-2 py-1 rounded text-[10px] whitespace-nowrap border ${listFilterDept === 'Gen2' ? 'bg-orange-600 border-orange-600 text-white' : 'border-slate-600 text-slate-300'}`}>IT ·ûá·üÜ·ûì·û∂·ûì·üã·ü¢</button>
                                            <button onClick={() => setListFilterDept('Assistant')} className={`px-2 py-1 rounded text-[10px] whitespace-nowrap border ${listFilterDept === 'Assistant' ? 'bg-orange-600 border-orange-600 text-white' : 'border-slate-600 text-slate-300'}`}>·ûá·üÜ·ûì·ûΩ·ûô·ûÄ·û∂·ûö</button>
                                        </div>
                                        <div className="flex items-center gap-2 overflow-x-auto pb-1 no-scrollbar">
                                            <span className="text-[10px] text-slate-400 whitespace-nowrap flex items-center gap-1"><UsersIcon className="w-3 h-3"/> ·ûÄ·üí·ûö·ûª·ûò:</span>
                                            <button onClick={() => setListFilterGroup('All')} className={`px-2 py-1 rounded text-[10px] whitespace-nowrap border ${listFilterGroup === 'All' ? 'bg-indigo-600 border-indigo-600 text-white' : 'border-slate-600 text-slate-300'}`}>·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã</button>
                                            <button onClick={() => setListFilterGroup('IT')} className={`px-2 py-1 rounded text-[10px] whitespace-nowrap border ${listFilterGroup === 'IT' ? 'bg-cyan-600 border-cyan-600 text-white' : 'border-slate-600 text-slate-300'}`}>IT Support</button>
                                            <button onClick={() => setListFilterGroup('DRB')} className={`px-2 py-1 rounded text-[10px] whitespace-nowrap border ${listFilterGroup === 'DRB' ? 'bg-cyan-600 border-cyan-600 text-white' : 'border-slate-600 text-slate-300'}`}>DRB</button>
                                        </div>
                                    </div>

                                    {/* NEW: Toggle All Visible Buttons */}
                                    <div className="flex gap-2 pt-2 border-t border-slate-700/50 mt-2">
                                        <button
                                            onClick={() => toggleAllVisible(true)}
                                            className="flex-1 bg-green-600/20 hover:bg-green-600/30 text-green-400 text-xs py-2 rounded-lg flex items-center justify-center gap-2 transition-colors border border-green-600/30"
                                        >
                                            <CheckSquare className="w-3 h-3" /> ·ûî·ûæ·ûÄ·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã ({displayedStudents.length})
                                        </button>
                                        <button
                                            onClick={() => toggleAllVisible(false)}
                                            className="flex-1 bg-red-600/20 hover:bg-red-600/30 text-red-400 text-xs py-2 rounded-lg flex items-center justify-center gap-2 transition-colors border border-red-600/30"
                                        >
                                            <Square className="w-3 h-3" /> ·ûî·û∑·ûë·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã ({displayedStudents.length})
                                        </button>
                                    </div>
                                </div>

                                <div className="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar">
                                    {displayedStudents.length > 0 ? (
                                        displayedStudents.map(renderStudentListItem)
                                    ) : (
                                        <div className="text-center text-slate-500 py-10 flex flex-col items-center gap-2">
                                            <ListFilter className="w-10 h-10 opacity-20" />
                                            <span>·ûö·ûÄ·ûò·û∑·ûì·ûÉ·ûæ·ûâ·ûà·üí·ûò·üÑ·üá·ûè·û∂·ûò·ûõ·ûÄ·üí·ûÅ·ûÅ·ûé·üí·ûå</span>
                                        </div>
                                    )}
                                </div>
                                
                                <div className="p-4 border-t border-slate-700 bg-slate-800 rounded-b-2xl">
                                    <div className="flex justify-between text-xs text-slate-400 mb-3">
                                        <span>·ûî·û∑·ûë (Excluded): {excludedNames.length}</span>
                                        <span>·ûî·ûæ·ûÄ (Active): {allStudents.length - excludedNames.length}</span>
                                    </div>
                                    <button onClick={() => setShowStudentList(false)} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-all">
                                        ·ûö·ûΩ·ûÖ·ûö·û∂·ûõ·üã
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 z-50 overflow-y-auto bg-black/60 backdrop-blur-sm">
                            <div className="flex min-h-full items-center justify-center p-4">
                                <div className="bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-md p-6 relative animate-in zoom-in-95 duration-200">
                                    <button 
                                        onClick={() => setShowSettings(false)}
                                        className="absolute top-4 right-4 text-slate-400 hover:text-white transition-colors"
                                    >
                                        <X className="w-6 h-6" />
                                    </button>
                                    
                                    <h2 className="text-xl font-bold text-white mb-6 flex items-center gap-2">
                                        <Settings className="w-6 h-6 text-indigo-400" />
                                        ·ûÄ·û∂·ûö·ûÄ·üÜ·ûé·ûè·üã (Realtime DB)
                                    </h2>
                                    
                                    <div className="space-y-6">
                                        
                                        {/* Student List Button */}
                                        <div className="bg-indigo-600/10 border border-indigo-500/30 rounded-xl p-4 flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className="bg-indigo-500/20 p-2 rounded-full">
                                                    <UserCog className="w-5 h-5 text-indigo-400" />
                                                </div>
                                                <div className="flex flex-col">
                                                    <span className="text-sm font-semibold text-white">·ûî·ûâ·üí·ûá·û∏·ûà·üí·ûò·üÑ·üá·ûü·û∑·ûü·üí·ûü</span>
                                                    <span className="text-xs text-indigo-300">·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ·ûÄ·û∂·ûö·ûî·û∑·ûë/·ûî·ûæ·ûÄ·ûà·üí·ûò·üÑ·üá</span>
                                                </div>
                                            </div>
                                            <button 
                                                onClick={() => setShowStudentList(true)}
                                                className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold rounded-lg transition-colors flex items-center gap-1"
                                            >
                                                ·ûî·ûæ·ûÄ·ûò·ûæ·ûõ <Users className="w-3 h-3" />
                                            </button>
                                        </div>

                                        {/* Telegram Config */}
                                        <div className="space-y-3 pb-4 border-b border-slate-700">
                                            <div className="flex items-center gap-2 text-slate-300 mb-2">
                                                <Cloud className="w-4 h-4 text-blue-400" />
                                                <h3 className="text-sm font-semibold">·ûÄ·û∂·ûö·ûó·üí·ûá·û∂·ûî·üã Telegram</h3>
                                            </div>
                                            
                                            {/* Bot Token Input */}
                                            <div>
                                                <label className="block text-slate-400 text-xs mb-1 flex items-center gap-2">
                                                    Bot Token <Lock className="w-3 h-3 text-green-400" />
                                                </label>
                                                <div className="relative">
                                                    <input 
                                                        type={showBotToken ? "text" : "password"}
                                                        value={botToken}
                                                        onChange={(e) => setBotToken(e.target.value)}
                                                        placeholder="Ex: 7048123456:AAGq..."
                                                        className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 pr-10 text-white focus:outline-none focus:border-indigo-500 text-sm font-mono no-select"
                                                        autoComplete="off"
                                                        onCopy={(e) => e.preventDefault()}
                                                        onCut={(e) => e.preventDefault()}
                                                    />
                                                    <button
                                                        type="button"
                                                        onClick={() => setShowBotToken(!showBotToken)}
                                                        className="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-white"
                                                    >
                                                        {showBotToken ? <EyeOff className="w-4 h-4" /> : <Eye className="w-4 h-4" />}
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Channel List */}
                                            <div className="space-y-2">
                                                <div className="flex items-center justify-between">
                                                    <label className="block text-slate-400 text-xs">Chat IDs / Channels</label>
                                                    <button 
                                                        onClick={addChannel}
                                                        className="text-xs text-indigo-400 hover:text-indigo-300 flex items-center gap-1"
                                                    >
                                                        <Plus className="w-3 h-3" /> ·ûî·ûì·üí·ûê·üÇ·ûò·ûê·üí·ûò·û∏
                                                    </button>
                                                </div>

                                                {telegramChannels.map((channel, index) => (
                                                    <div key={channel.id} className="bg-slate-900/50 p-3 rounded-lg border border-slate-700 space-y-2">
                                                        <div className="flex items-center justify-between gap-2">
                                                            <input 
                                                                type="text"
                                                                value={channel.name}
                                                                onChange={(e) => updateChannel(channel.id, 'name', e.target.value)}
                                                                placeholder="·ûà·üí·ûò·üÑ·üá (·ûß. Group IT)"
                                                                className="flex-1 bg-transparent border-b border-slate-600 text-xs text-white placeholder-slate-500 focus:outline-none focus:border-indigo-500 py-1"
                                                            />
                                                            <div className="flex items-center gap-2">
                                                                <button 
                                                                    onClick={() => toggleChannelActive(channel.id)}
                                                                    className={`p-1.5 rounded-md transition-colors ${channel.active ? 'bg-green-500/20 text-green-400' : 'bg-slate-700 text-slate-500'}`}
                                                                    title={channel.active ? "·ûÄ·üÜ·ûñ·ûª·ûÑ·ûî·ûæ·ûÄ" : "·ûÄ·üÜ·ûñ·ûª·ûÑ·ûî·û∑·ûë"}
                                                                >
                                                                    <Power className="w-3.5 h-3.5" />
                                                                </button>
                                                                <button 
                                                                    onClick={() => removeChannel(channel.id)}
                                                                    className="p-1.5 rounded-md hover:bg-red-500/20 text-slate-500 hover:text-red-400 transition-colors"
                                                                >
                                                                    <Trash2 className="w-3.5 h-3.5" />
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <input 
                                                            type="text"
                                                            value={channel.chatId}
                                                            onChange={(e) => updateChannel(channel.id, 'chatId', e.target.value)}
                                                            placeholder="Chat ID (Ex: -100...)"
                                                            className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1.5 text-xs font-mono text-slate-300 focus:outline-none focus:border-indigo-500"
                                                        />
                                                    </div>
                                                ))}
                                                
                                                {telegramChannels.length === 0 && (
                                                    <div className="text-center text-xs text-slate-500 py-2 border border-dashed border-slate-700 rounded-lg">
                                                        ·ûò·û∑·ûì·ûë·û∂·ûì·üã·ûò·û∂·ûì Chat ID ·ûì·üÖ·û°·ûæ·ûô·üî
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        {/* General Toggles */}
                                        <div className="space-y-4 border-b border-slate-700 pb-4">
                                            <div className="flex items-center justify-between">
                                                <div className="flex flex-col">
                                                    <span className="text-sm text-white font-medium">·ûï·üí·ûâ·ûæ·ûü·û∂·ûö·ûü·üí·ûú·üê·ûô·ûî·üí·ûö·ûú·ûè·üí·ûè·û∑</span>
                                                    <span className="text-xs text-slate-400">·ûï·üí·ûâ·ûæ·ûë·üÖ Telegram ·ûó·üí·ûõ·û∂·ûò·üó</span>
                                                </div>
                                                <button onClick={toggleAutoSend} className={`w-12 h-6 rounded-full p-1 transition-colors ${autoSendTelegram ? 'bg-indigo-500' : 'bg-slate-600'}`}>
                                                    <div className={`bg-white w-4 h-4 rounded-full shadow-md transform duration-200 ${autoSendTelegram ? 'translate-x-6' : 'translate-x-0'}`}></div>
                                                </button>
                                            </div>

                                            <div className="flex items-center justify-between">
                                                <div className="flex flex-col">
                                                    <span className="text-sm text-white font-medium">·û†·üÖ·ûè·üÇ·ûà·üí·ûò·üÑ·üá·ûê·üí·ûò·û∏ (Unique)</span>
                                                    <span className="text-xs text-slate-400">·ûò·û∑·ûì·û†·üÖ·ûà·üí·ûò·üÑ·üá·ûä·ûä·üÇ·ûõ·ûÄ·üí·ûì·ûª·ûÑ·ûê·üí·ûÑ·üÉ·ûì·üÅ·üá</span>
                                                </div>
                                                <button onClick={toggleFilterUnique} className={`w-12 h-6 rounded-full p-1 transition-colors ${filterUniqueWinners ? 'bg-indigo-500' : 'bg-slate-600'}`}>
                                                    <div className={`bg-white w-4 h-4 rounded-full shadow-md transform duration-200 ${filterUniqueWinners ? 'translate-x-6' : 'translate-x-0'}`}></div>
                                                </button>
                                            </div>
                                            
                                            {filterUniqueWinners && todaysWinners.length > 0 && (
                                                <div className="flex justify-between items-center bg-slate-900/50 p-2 rounded-lg">
                                                    <span className="text-xs text-slate-400">·ûî·û∂·ûì·û†·üÖ: {todaysWinners.length} ·ûì·û∂·ûÄ·üã</span>
                                                    <button onClick={clearTodaysWinners} className="text-xs text-red-400 hover:text-red-300 flex items-center gap-1">
                                                        <RotateCcw className="w-3 h-3" /> Reset
                                                    </button>
                                                </div>
                                            )}
                                        </div>

                                        {/* Department Filter Section */}
                                        <div className="space-y-3 pb-4 border-b border-slate-700">
                                            <div className="flex items-center gap-2 text-slate-300">
                                                <Briefcase className="w-4 h-4 text-orange-400" />
                                                <h3 className="text-sm font-semibold">Filter ·ûè·û∂·ûò·ûï·üí·ûì·üÇ·ûÄ·ûÄ·û∂·ûö·ûÑ·û∂·ûö (Department)</h3>
                                            </div>
                                            <div className="space-y-2 pl-2">
                                                <div className="flex items-center justify-between">
                                                    <span className="text-xs text-slate-300">Training_·ûá·üÜ·ûì·ûΩ·ûô·ûÄ·û∂·ûö·ûõ·üÑ·ûÄ·ûÇ·üí·ûö·ûº·ûä·û∂·ûö·üâ·ûº</span>
                                                    <button onClick={toggleDeptTraining} className={`w-10 h-5 rounded-full p-0.5 transition-colors ${filterDeptTraining ? 'bg-orange-500' : 'bg-slate-600'}`}>
                                                        <div className={`bg-white w-4 h-4 rounded-full shadow-md transform duration-200 ${filterDeptTraining ? 'translate-x-5' : 'translate-x-0'}`}></div>
                                                    </button>
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <span className="text-xs text-slate-300">·ûö·üÄ·ûì·ûú·ûÇ·üí·ûÇ·ûî·ûé·üí·ûä·ûª·üá·ûî·ûé·üí·ûä·û∂·ûõIT_·ûá·üÜ·ûì·û∂·ûì·üã·ü¢</span>
                                                    <button onClick={toggleDeptITGen2} className={`w-10 h-5 rounded-full p-0.5 transition-colors ${filterDeptITGen2 ? 'bg-orange-500' : 'bg-slate-600'}`}>
                                                        <div className={`bg-white w-4 h-4 rounded-full shadow-md transform duration-200 ${filterDeptITGen2 ? 'translate-x-5' : 'translate-x-0'}`}></div>
                                                    </button>
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <span className="text-xs text-slate-300">·ûá·üÜ·ûì·ûΩ·ûô·ûÄ·û∂·ûö_·ûõ·üÑ·ûÄ·ûÇ·üí·ûö·ûº·ûä·û∂·ûö·üâ·ûº</span>
                                                    <button onClick={toggleDeptAssistant} className={`w-10 h-5 rounded-full p-0.5 transition-colors ${filterDeptAssistant ? 'bg-orange-500' : 'bg-slate-600'}`}>
                                                        <div className={`bg-white w-4 h-4 rounded-full shadow-md transform duration-200 ${filterDeptAssistant ? 'translate-x-5' : 'translate-x-0'}`}></div>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Group Filter Section */}
                                        <div className="space-y-3">
                                            <div className="flex items-center gap-2 text-slate-300">
                                                <UsersIcon className="w-4 h-4 text-cyan-400" />
                                                <h3 className="text-sm font-semibold">Filter ·ûè·û∂·ûò·ûÄ·üí·ûö·ûª·ûò (Group)</h3>
                                            </div>
                                            <div className="space-y-2 pl-2">
                                                <div className="flex items-center justify-between">
                                                    <span className="text-xs text-slate-300">IT Support</span>
                                                    <button onClick={toggleGroupITSupport} className={`w-10 h-5 rounded-full p-0.5 transition-colors ${filterGroupITSupport ? 'bg-cyan-500' : 'bg-slate-600'}`}>
                                                        <div className={`bg-white w-4 h-4 rounded-full shadow-md transform duration-200 ${filterGroupITSupport ? 'translate-x-5' : 'translate-x-0'}`}></div>
                                                    </button>
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <span className="text-xs text-slate-300">DRB</span>
                                                    <button onClick={toggleGroupDRB} className={`w-10 h-5 rounded-full p-0.5 transition-colors ${filterGroupDRB ? 'bg-cyan-500' : 'bg-slate-600'}`}>
                                                        <div className={`bg-white w-4 h-4 rounded-full shadow-md transform duration-200 ${filterGroupDRB ? 'translate-x-5' : 'translate-x-0'}`}></div>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <button 
                                            onClick={handleSaveSettingsButton}
                                            disabled={isSaving}
                                            className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition-all mt-4 disabled:opacity-50"
                                        >
                                            {isSaving ? <RefreshCw className="w-5 h-5 animate-spin" /> : <Save className="w-5 h-5" />}
                                            {isSaving ? "·ûÄ·üÜ·ûñ·ûª·ûÑ·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ..." : "·ûî·û∑·ûë Settings"}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="bg-white/10 backdrop-blur-md rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden border border-white/20">
                        
                        {/* Header */}
                        <div className="bg-indigo-600/80 p-6 text-center relative">
                            <h1 className="text-2xl md:text-3xl font-bold text-white flex items-center justify-center gap-3 drop-shadow-md">
                                <Database className="w-8 h-8" />
                                <span>Random Student Picker</span>
                            </h1>
                            
                            <div className="flex justify-center gap-3 mt-4 flex-wrap">
                                <div className="bg-black/30 px-3 py-1 rounded-full text-xs flex items-center gap-2 border border-white/10">
                                    <Calendar className="w-3 h-3 text-indigo-300" />
                                    <span>{getTodayDateStr()}</span>
                                </div>
                                <div className="bg-black/30 px-3 py-1 rounded-full text-xs flex items-center gap-2 border border-white/10">
                                    <Clock className="w-3 h-3 text-pink-300" />
                                    <span>{getCurrentShift()}</span>
                                </div>
                            </div>

                            <div className="absolute top-5 right-5">
                                {loading ? (
                                    <div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                                ) : (
                                    <div className={`h-3 w-3 rounded-full shadow-lg border border-white/50 ${allStudents.length > 0 ? 'bg-green-400' : 'bg-red-500'}`} 
                                            title={allStudents.length > 0 ? "Online Mode" : "No Data"}></div>
                                )}
                            </div>
                        </div>

                        {/* Content */}
                        <div className="p-8 flex flex-col items-center">
                            
                            <div className={`
                                relative w-full aspect-video rounded-2xl flex flex-col items-center justify-center mb-6 transition-all duration-500
                                ${winner 
                                    ? 'bg-gradient-to-tr from-green-500 to-emerald-600 scale-105 shadow-[0_0_40px_rgba(16,185,129,0.5)] border-2 border-white/30' 
                                    : 'bg-white/5 shadow-inner border border-white/10'
                                }
                            `}>
                                {winner && (
                                    <div className="absolute -top-8 animate-bounce z-10">
                                        <Trophy className="w-16 h-16 text-yellow-400 drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)]" />
                                    </div>
                                )}
                                
                                <UserCircle className={`w-20 h-20 mb-4 transition-colors duration-300 ${winner ? 'text-white' : 'text-white/20'}`} />
                                
                                <h2 className={`text-4xl md:text-5xl font-bold text-center transition-all duration-300 ${winner ? 'text-white scale-110 drop-shadow-md' : 'text-white/50'}`}>
                                    {currentName}
                                </h2>
                                
                                {winner && (
                                    <div className="mt-4 text-center animate-pulse flex flex-col items-center gap-2">
                                        <span className="bg-white/20 px-4 py-1 rounded-full text-sm font-medium">
                                            ·ûú·üÅ·ûì: {winner.shift}
                                        </span>
                                        {/* Status Text for Telegram */}
                                        {autoSendTelegram && botToken && (
                                            <span className="text-xs text-blue-300 flex items-center gap-1">
                                                <Send className="w-3 h-3" />
                                                {sendingTelegram ? "·ûÄ·üÜ·ûñ·ûª·ûÑ·ûï·üí·ûâ·ûæ..." : "·ûî·û∂·ûì·ûï·üí·ûâ·ûæ·ûü·üí·ûú·üê·ûô·ûî·üí·ûö·ûú·ûè·üí·ûè·û∑"}
                                            </span>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Manual Send Button */}
                            {winner && manualSendVisible && (
                                <button
                                    onClick={() => sendToTelegram(winner)}
                                    disabled={sendingTelegram}
                                    className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 shadow-lg mb-4 transition-all animate-bounce-short"
                                >
                                    <Send className="w-5 h-5" />
                                    {sendingTelegram ? "·ûÄ·üÜ·ûñ·ûª·ûÑ·ûï·üí·ûâ·ûæ..." : "·ûï·üí·ûâ·ûæ·ûü·û∂·ûö·ûë·üÖ Telegram"}
                                </button>
                            )}

                            <button
                                onClick={handleSpin}
                                disabled={isSpinning || loading || playableStudents.length === 0}
                                className={`
                                    w-full py-4 px-8 rounded-xl text-xl font-bold text-white shadow-xl transform transition-all duration-200 active:scale-95 flex items-center justify-center gap-3 border border-white/20 mb-6
                                    ${isSpinning || playableStudents.length === 0
                                        ? 'bg-slate-600/50 cursor-not-allowed opacity-70' 
                                        : 'bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-400 hover:to-purple-500 hover:shadow-indigo-500/40'
                                    }
                                `}
                            >
                                {isSpinning ? (
                                    <>
                                        <RefreshCw className="w-6 h-6 animate-spin" />
                                        ·ûÄ·üÜ·ûñ·ûª·ûÑ·ûÖ·û∂·ûî·üã·ûà·üí·ûò·üÑ·üá...
                                    </>
                                ) : (
                                    <>
                                        <Shuffle className="w-6 h-6" />
                                        {winner ? '·ûÖ·û∂·ûî·üã·ûà·üí·ûò·üÑ·üá·ûò·üí·ûè·ûÑ·ûë·üÄ·ûè' : '·ûÖ·û∂·ûî·üã·ûï·üí·ûè·ûæ·ûò·û†·üÖ·ûà·üí·ûò·üÑ·üá'}
                                    </>
                                )}
                            </button>

                            {/* Custom Message Input */}
                            <div className="w-full relative mb-6">
                                <label className="text-xs text-slate-400 mb-2 block flex items-center gap-1">
                                    <MessageSquare className="w-3 h-3" />
                                    ·ûü·û∂·ûö·ûó·üí·ûá·û∂·ûî·üã·ûá·û∂·ûò·ûΩ·ûô·ûà·üí·ûò·üÑ·üá (Cloud Sync)
                                </label>
                                <input 
                                    type="text" 
                                    value={customMessage}
                                    onChange={(e) => setCustomMessage(e.target.value)}
                                    onBlur={handleMessageBlur}
                                    placeholder="·ûß·ûë·û∂·û†·ûö·ûé·üç: ·ûü·ûº·ûò·ûò·ûÄ·ûë·ûë·ûΩ·ûõ·ûö·ûÑ·üí·ûú·û∂·ûì·üã..."
                                    className="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-white placeholder-slate-500 focus:outline-none focus:border-indigo-500 transition-colors text-sm"
                                />
                            </div>

                            <div className="mt-2 w-full space-y-3 border-t border-white/10 pt-4">
                                <div className="flex justify-between items-center text-slate-400 text-xs font-mono">
                                    <div className="flex flex-col">
                                        <span>Total Active: {allStudents.length}</span>
                                        {(filterUniqueWinners || filterDeptTraining || filterDeptITGen2 || filterGroupITSupport || filterGroupDRB || excludedNames.length > 0) && (
                                            <span className="text-[10px] text-green-400">Playable: {playableStudents.length} (Filter On)</span>
                                        )}
                                    </div>
                                    <button 
                                        onClick={() => setShowSettings(true)}
                                        className="flex items-center gap-1 hover:text-white transition-colors"
                                    >
                                        <span className={`w-2 h-2 rounded-full ${settingsLoaded && botToken ? 'bg-green-500' : 'bg-slate-500'}`}></span>
                                        Settings <Settings className="w-3 h-3" />
                                    </button>
                                </div>
                                
                                {debugInfo && !error && (
                                    <div className="bg-blue-500/10 text-blue-200 text-xs p-3 rounded-lg border border-blue-500/20 flex items-center gap-2">
                                        <CheckCircle2 className="w-4 h-4" />
                                        {debugInfo}
                                    </div>
                                )}

                                {error && (
                                    <div className="bg-red-500/10 text-red-200 text-xs p-3 rounded-lg border border-red-500/20 flex items-start gap-2">
                                        <AlertTriangle className="w-4 h-4 mt-0.5 flex-shrink-0" />
                                        <span>{error}</span>
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        <div className="bg-black/20 p-4 text-center text-slate-500 text-[10px] tracking-wider uppercase">
                            Random Student Picker System ‚Ä¢ {new Date().getFullYear()}
                        </div>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<RandomStudentApp />);
    </script>
</body>
</html>
