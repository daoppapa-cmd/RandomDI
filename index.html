<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Student Picker - Firebase</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font for Khmer Language (Google Fonts) -->
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM & Babel -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "firebase/app": "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js",
                "firebase/database": "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js",
                "lucide-react": "https://esm.sh/lucide-react@0.378.0"
            }
        }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05); 
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2); 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3); 
        }
        .no-select {
            -webkit-user-select: none;
            user-select: none;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.5); border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously } from 'firebase/auth';
        import { 
            getFirestore, 
            collectionGroup, 
            getDocs, 
            query, 
            where, 
            limit 
        } from 'firebase/firestore';
        // Updated Imports for Firebase Database (Added 'get')
        import { getDatabase, ref, update, onValue, push, set, remove, get } from 'firebase/database';
        import { 
            Users, Shuffle, RefreshCw, Trophy, UserCircle, 
            Settings, AlertTriangle, Database, Clock, 
            Calendar, CheckCircle2, Send, X, Save, MessageSquare, 
            ToggleLeft, ToggleRight, UserMinus, RotateCcw, Cloud,
            Eye, EyeOff, Lock, Filter, Briefcase, Users as UsersIcon,
            UserCog, Search, Check, Ban, ListFilter, Plus, Trash2, Power,
            CheckSquare, Square, History, FileClock
        } from 'lucide-react';

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCgc3fq9mDHMCjTRRHD3BPBL31JkKZgXFc",
            authDomain: "checkme-10e18.firebaseapp.com",
            databaseURL: "https://checkme-10e18-default-rtdb.firebaseio.com",
            projectId: "checkme-10e18",
            storageBucket: "checkme-10e18.firebasestorage.app",
            messagingSenderId: "1030447497157",
            appId: "1:1030447497157:web:9792086df1e864559fd5ac",
            measurementId: "G-QCJ2JH4WH6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        // --- Helpers ---
        const getTodayDateStr = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const getCurrentShift = () => {
            const hour = new Date().getHours();
            if (hour >= 6 && hour < 12) return "áœáŸá“á–áŸ’ášá¹á€"; 
            if (hour >= 12 && hour < 17) return "áœáŸá“ášáŸáŸ€á›"; 
            if (hour >= 17) return "áœáŸá“á™á”áŸ‹"; 
            return "á€áŸ’ášáŸ…á˜áŸ‰áŸ„á„";
        };

        const normalizeStr = (str) => {
            return (str || '').toLowerCase().replace(/[\s_-]+/g, '');
        };

        // Format Date for History
        const formatDateTime = (timestamp) => {
            const date = new Date(timestamp);
            return date.toLocaleString('km-KH', { 
                month: 'short', day: 'numeric', 
                hour: '2-digit', minute: '2-digit' 
            });
        };

        // --- Main Component ---
        const RandomStudentApp = () => {
            const [allStudents, setAllStudents] = useState([]); 
            const [playableStudents, setPlayableStudents] = useState([]); 
            
            const [currentName, setCurrentName] = useState("ááŸ’ášáŸ€á˜ááŸ’á›á½á“...");
            const [winner, setWinner] = useState(null);
            const [isSpinning, setIsSpinning] = useState(false);
            const [loading, setLoading] = useState(true);
            const [useDemoData, setUseDemoData] = useState(false);
            const [error, setError] = useState(null);
            const [debugInfo, setDebugInfo] = useState("");
            const [sendingTelegram, setSendingTelegram] = useState(false);
            const [manualSendVisible, setManualSendVisible] = useState(false);

            // --- Settings State ---
            const [showSettings, setShowSettings] = useState(false);
            const [settingsTab, setSettingsTab] = useState('general'); // 'general' | 'history'
            const [showStudentList, setShowStudentList] = useState(false);
            
            const [botToken, setBotToken] = useState("");
            const [telegramChannels, setTelegramChannels] = useState([]); 
            const [customMessage, setCustomMessage] = useState("");
            
            // Core Settings
            const [autoSendTelegram, setAutoSendTelegram] = useState(true);
            const [filterUniqueWinners, setFilterUniqueWinners] = useState(false);
            const [todaysWinners, setTodaysWinners] = useState([]);
            
            // Confirmation States
            const [confirmResetWinners, setConfirmResetWinners] = useState(false);
            const [confirmResetHistory, setConfirmResetHistory] = useState(false);

            // History Data
            const [historyData, setHistoryData] = useState([]);

            // Global Filters
            const [filterDeptTraining, setFilterDeptTraining] = useState(false);
            const [filterDeptITGen2, setFilterDeptITGen2] = useState(false);
            const [filterDeptAssistant, setFilterDeptAssistant] = useState(false);
            const [filterGroupITSupport, setFilterGroupITSupport] = useState(false);
            const [filterGroupDRB, setFilterGroupDRB] = useState(false);

            // Student List Modal Filters
            const [listFilterDept, setListFilterDept] = useState('All');
            const [listFilterGroup, setListFilterGroup] = useState('All');
            const [studentSearchTerm, setStudentSearchTerm] = useState("");

            // Excluded Students
            const [excludedNames, setExcludedNames] = useState([]); 

            const [isSaving, setIsSaving] = useState(false);
            const [showBotToken, setShowBotToken] = useState(false);
            const [settingsLoaded, setSettingsLoaded] = useState(false);

            const intervalRef = useRef(null);

            // --- 1. Load Settings from Realtime Database ---
            useEffect(() => {
                const settingsRef = ref(rtdb, 'settings/appConfig');
                
                const unsubscribe = onValue(settingsRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        if (data.botToken) setBotToken(data.botToken);
                        if (data.customMessage) setCustomMessage(data.customMessage);
                        if (data.autoSendTelegram !== undefined) setAutoSendTelegram(data.autoSendTelegram);
                        if (data.filterUniqueWinners !== undefined) setFilterUniqueWinners(data.filterUniqueWinners);
                        
                        if (data.telegramChannels && Array.isArray(data.telegramChannels)) {
                            setTelegramChannels(data.telegramChannels);
                        } else if (data.chatId) {
                            setTelegramChannels([
                                { id: 'default', name: 'Default Group', chatId: data.chatId, active: true }
                            ]);
                        } else {
                            setTelegramChannels([]);
                        }
                        
                        if (data.filterDeptTraining !== undefined) setFilterDeptTraining(data.filterDeptTraining);
                        if (data.filterDeptITGen2 !== undefined) setFilterDeptITGen2(data.filterDeptITGen2);
                        if (data.filterDeptAssistant !== undefined) setFilterDeptAssistant(data.filterDeptAssistant);
                        if (data.filterGroupITSupport !== undefined) setFilterGroupITSupport(data.filterGroupITSupport);
                        if (data.filterGroupDRB !== undefined) setFilterGroupDRB(data.filterGroupDRB);
                        
                        if (data.excludedNames) {
                            const names = Array.isArray(data.excludedNames) ? data.excludedNames : Object.values(data.excludedNames || {});
                            setExcludedNames(names);
                        } else {
                            setExcludedNames([]);
                        }
                    }
                    setSettingsLoaded(true);
                });

                return () => unsubscribe();
            }, []);

            // --- 2. Load Public Today's Winners from DB ---
            useEffect(() => {
                const winnersRef = ref(rtdb, `daily_winners/${getTodayDateStr()}`);
                
                const unsubscribe = onValue(winnersRef, (snapshot) => {
                    const data = snapshot.val();
                    const winnersList = data ? Object.values(data) : [];
                    setTodaysWinners(winnersList);
                });

                return () => unsubscribe();
            }, []);

            // --- 3. History Management (Load & Auto-Delete) ---
            useEffect(() => {
                // A. Cleanup Old History (Older than 1 Month)
                const historyRef = ref(rtdb, 'call_history');
                
                // Run cleanup once on mount
                get(historyRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        const now = Date.now();
                        const oneMonthMs = 30 * 24 * 60 * 60 * 1000; // 30 days
                        
                        Object.keys(data).forEach(key => {
                            if (data[key].timestamp && (now - data[key].timestamp > oneMonthMs)) {
                                remove(ref(rtdb, `call_history/${key}`));
                            }
                        });
                    }
                }).catch(err => console.error("Cleanup error:", err));

                // B. Listen for History Updates
                const unsubscribe = onValue(historyRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        // Convert to array and sort by timestamp desc
                        const list = Object.values(data).sort((a, b) => b.timestamp - a.timestamp);
                        setHistoryData(list);
                    } else {
                        setHistoryData([]);
                    }
                });

                return () => unsubscribe();
            }, []);

            // --- PLAYABLE LIST LOGIC ---
            useEffect(() => {
                let filtered = allStudents;

                if (excludedNames.length > 0) {
                    filtered = filtered.filter(s => !excludedNames.includes(s.name));
                }

                if (filterUniqueWinners) {
                    filtered = filtered.filter(s => !todaysWinners.includes(s.name));
                }

                const activeDeptFilters = [];
                if (filterDeptTraining) activeDeptFilters.push("Training"); 
                if (filterDeptITGen2) activeDeptFilters.push("á‡áŸ†á“á¶á“áŸ‹áŸ¢");
                if (filterDeptAssistant) activeDeptFilters.push("á‡áŸ†á“á½á™á€á¶áš_á›áŸ„á€á‚áŸ’ášá¼áŠá¶ášáŸ‰á¼"); 
                
                if (activeDeptFilters.length > 0) {
                    filtered = filtered.filter(s => {
                        const sDept = (s.department || '').toLowerCase();
                        return activeDeptFilters.some(f => sDept.includes(f.toLowerCase()));
                    });
                }

                const activeGroupFilters = [];
                if (filterGroupITSupport) activeGroupFilters.push("IT Support");
                if (filterGroupDRB) activeGroupFilters.push("DRB");

                if (activeGroupFilters.length > 0) {
                    filtered = filtered.filter(s => {
                        const groupRaw = (s.group || '').toLowerCase() + " " + (s.department || '').toLowerCase();
                        const groupNormalized = groupRaw.replace(/[\s_-]+/g, '');
                        
                        return activeGroupFilters.some(filterLabel => {
                            if (filterLabel === "IT Support") {
                                return groupNormalized.includes("itsupport");
                            }
                            if (filterLabel === "DRB") {
                                return groupNormalized.includes("drb");
                            }
                            return false;
                        });
                    });
                }

                setPlayableStudents(filtered);
            }, [
                allStudents, 
                excludedNames,
                filterUniqueWinners, 
                todaysWinners, 
                filterDeptTraining, 
                filterDeptITGen2,
                filterDeptAssistant,
                filterGroupITSupport, 
                filterGroupDRB
            ]);

            // --- UPDATE SETTINGS ---
            const updateSetting = async (updates) => {
                try {
                    await update(ref(rtdb, 'settings/appConfig'), {
                        ...updates,
                        updatedAt: new Date().toISOString()
                    });
                } catch (err) {
                    console.error("Error updating setting:", err);
                }
            };

            const handleSaveSettingsButton = async () => {
                setIsSaving(true);
                const cleanChannels = telegramChannels.filter(c => c.chatId.trim() !== "");
                
                await updateSetting({
                    botToken,
                    telegramChannels: cleanChannels,
                    customMessage,
                    autoSendTelegram,
                    filterUniqueWinners,
                    filterDeptTraining,
                    filterDeptITGen2,
                    filterDeptAssistant, 
                    filterGroupITSupport,
                    filterGroupDRB,
                    excludedNames
                });
                setTelegramChannels(cleanChannels);
                setIsSaving(false);
                setShowSettings(false);
            };

            // --- Channel Management Functions ---
            const addChannel = () => {
                setTelegramChannels([...telegramChannels, { id: Date.now().toString(), name: '', chatId: '', active: true }]);
            };

            const updateChannel = (id, field, value) => {
                setTelegramChannels(telegramChannels.map(c => c.id === id ? { ...c, [field]: value } : c));
            };

            const removeChannel = (id) => {
                setTelegramChannels(telegramChannels.filter(c => c.id !== id));
            };

            const toggleChannelActive = (id) => {
                setTelegramChannels(telegramChannels.map(c => c.id === id ? { ...c, active: !c.active } : c));
            };

            // Toggle Functions
            const toggleAutoSend = () => { const v = !autoSendTelegram; setAutoSendTelegram(v); updateSetting({ autoSendTelegram: v }); };
            const toggleFilterUnique = () => { const v = !filterUniqueWinners; setFilterUniqueWinners(v); updateSetting({ filterUniqueWinners: v }); };
            const toggleDeptTraining = () => { const v = !filterDeptTraining; setFilterDeptTraining(v); updateSetting({ filterDeptTraining: v }); };
            const toggleDeptITGen2 = () => { const v = !filterDeptITGen2; setFilterDeptITGen2(v); updateSetting({ filterDeptITGen2: v }); };
            const toggleDeptAssistant = () => { const v = !filterDeptAssistant; setFilterDeptAssistant(v); updateSetting({ filterDeptAssistant: v }); }; 
            const toggleGroupITSupport = () => { const v = !filterGroupITSupport; setFilterGroupITSupport(v); updateSetting({ filterGroupITSupport: v }); };
            const toggleGroupDRB = () => { const v = !filterGroupDRB; setFilterGroupDRB(v); updateSetting({ filterGroupDRB: v }); };

            const handleMessageBlur = () => { updateSetting({ customMessage }); };

            const toggleStudentExclusion = (studentName) => {
                let newExcluded;
                if (excludedNames.includes(studentName)) {
                    newExcluded = excludedNames.filter(name => name !== studentName);
                } else {
                    newExcluded = [...excludedNames, studentName];
                }
                setExcludedNames(newExcluded);
                updateSetting({ excludedNames: newExcluded });
            };

            const toggleAllVisible = (enable) => {
                const visibleNames = displayedStudents.map(s => s.name);
                let newExcluded;

                if (enable) {
                    newExcluded = excludedNames.filter(name => !visibleNames.includes(name));
                } else {
                    const currentExcludedSet = new Set(excludedNames);
                    visibleNames.forEach(name => currentExcludedSet.add(name));
                    newExcluded = Array.from(currentExcludedSet);
                }

                setExcludedNames(newExcluded);
                updateSetting({ excludedNames: newExcluded });
            };

            const handleClearWinners = () => {
                if (confirmResetWinners) {
                    remove(ref(rtdb, `daily_winners/${getTodayDateStr()}`));
                    setConfirmResetWinners(false);
                } else {
                    setConfirmResetWinners(true);
                    setTimeout(() => setConfirmResetWinners(false), 3000);
                }
            };

            const handleClearHistory = () => {
                if (confirmResetHistory) {
                    remove(ref(rtdb, 'call_history'));
                    setConfirmResetHistory(false);
                } else {
                    setConfirmResetHistory(true);
                    setTimeout(() => setConfirmResetHistory(false), 3000);
                }
            };

            // Telegram Sending
            const sendToTelegram = async (student) => {
                const cleanToken = botToken.trim();
                const activeChannels = telegramChannels.filter(c => c.active && c.chatId.trim() !== "");

                if (!cleanToken || activeChannels.length === 0) {
                    if (manualSendVisible) {
                        const msg = !cleanToken ? "áŸá¼á˜á”á‰áŸ’á…á¼á› Bot Token á“áŸ…á€áŸ’á“á»á„ Settings!" : "áŸá¼á˜á”á‰áŸ’á…á¼á› Chat ID á“á·á„á”á¾á€áŠáŸ†áá¾ášá€á¶áš (Active) á™áŸ‰á¶á„á áŸ„á…áá¶áŸáŸ‹á˜á½á™!";
                        setError(msg);
                        setTimeout(() => setError(null), 5000);
                    }
                    return;
                }
                
                setSendingTelegram(true);

                // Gender Icon
                let icon = 'ğŸ¤';
                const name = student.name || '';
                const g = (student.gender || '').trim(); 
                const femaleKeywords = ['áŸáŸ’ášá¸', 'á“á¶á„', 'á€á‰áŸ’á‰á¶', 'á’á¸áá¶', 'á‘áŸáœá¸', 'á›á€áŸ’áá·áá¶', 'á…á¶á“áŸ‹', 'áá¶áœá¸', 'á’á¶ášá¸', 'á˜áŸ‰á¶á›á¸', 'áŸá»á•á¶', 'á€áŸ‚áœ', 'ášáŸááŸ’á“', 'á˜á¶á›á¶', 'á”á»á”áŸ’á•á¶', 'áŸáŸ„á—á¶', 'á€á“áŸ’á“á·áŠáŸ’á‹á¶', 'ášá…á“á¶', 'á–á·áŸá¸', 'áœááŸ’áá¸', 'á…á·á“áŸ’áá¶', 'ášáŸ‰á¶á“á¸', 'á›á¸áŠá¶', 'áŠá¶áœá¸', 'á¢á˜ášá¶', 'á€á»áŸá»á˜á¶', 'áœá·á…áŸ’á†á·á€á¶', 'áŠá¶á›á¸áŸ', 'á˜á»áŸ†', 'á•á›áŸ’á›á¶', 'áŸáŸ„á—áŸá'];

                if (g === 'áŸáŸ’ášá¸' || g.toLowerCase() === 'female' || g.toLowerCase() === 'f') {
                    icon = 'â¤ï¸';
                } else if (g === 'á”áŸ’ášá»áŸ' || g.toLowerCase() === 'male' || g.toLowerCase() === 'm') {
                    icon = 'ğŸ¤';
                } else {
                    if (femaleKeywords.some(k => name.includes(k))) icon = 'â¤ï¸';
                }

                let message = `${icon}${name}`;
                if (customMessage) message += ` ${customMessage}`;

                const promises = activeChannels.map(channel => {
                    const url = `https://api.telegram.org/bot${cleanToken}/sendMessage`;
                    return fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ chat_id: channel.chatId.trim(), text: message })
                    })
                    .then(res => res.json())
                    .then(data => ({ channelName: channel.name, success: data.ok, error: data.description }));
                });

                try {
                    const results = await Promise.all(promises);
                    const failures = results.filter(r => !r.success);
                    if (failures.length === 0) {
                        console.log("Message sent to all active channels successfully!");
                        setManualSendVisible(false);

                        // 1. Mark as Unique
                        if (filterUniqueWinners) {
                            if (!todaysWinners.includes(student.name)) {
                                const winnersRef = ref(rtdb, `daily_winners/${getTodayDateStr()}`);
                                push(winnersRef, student.name);
                            }
                        }

                        // 2. Add to History
                        const historyRef = ref(rtdb, 'call_history');
                        push(historyRef, {
                            name: student.name,
                            icon: icon,
                            message: customMessage || "",
                            timestamp: Date.now(),
                            channelCount: activeChannels.length
                        });

                    } else {
                        console.error("Some messages failed:", failures);
                        setManualSendVisible(true);
                        if (manualSendVisible) {
                            const errorMsg = `á”ášá¶á‡áŸá™ááŸ’á›áŸ‡:\n${failures.map(f => `- ${f.channelName || 'Unnamed'}: ${f.error}`).join('\n')}`;
                            setError(errorMsg);
                            setTimeout(() => setError(null), 8000);
                        }
                    }
                } catch (error) {
                    console.error("Network Error:", error);
                    setManualSendVisible(true); 
                    if (manualSendVisible) {
                        setError("á˜á¶á“á”á‰áŸ’á á¶ Network á˜á·á“á¢á¶á…á—áŸ’á‡á¶á”áŸ‹á‘áŸ… Telegram á”á¶á“á‘áŸáŸ”");
                        setTimeout(() => setError(null), 5000);
                    }
                } finally {
                    setSendingTelegram(false);
                }
            };

            // Fetch Students
            useEffect(() => {
                const fetchStudents = async () => {
                    setLoading(true);
                    setError(null);
                    setDebugInfo("");
                    
                    const todayStr = getTodayDateStr();
                    const currentShift = getCurrentShift();
                    
                    setDebugInfo(`á€áŸ†á–á»á„áŸáŸ’áœáŸ‚á„ášá€: ááŸ’á„áŸƒá‘á¸ ${todayStr} | áœáŸá“: ${currentShift}`);

                    try {
                        await signInAnonymously(auth);

                        const recordsQuery = query(
                            collectionGroup(db, 'records'),
                            where('date', '==', todayStr),
                            limit(100)
                        );

                        const querySnapshot = await getDocs(recordsQuery);
                        const fetchedStudents = [];
                        const uniqueNames = new Set();
                        let totalRecordsFound = 0;

                        querySnapshot.forEach((doc) => {
                            totalRecordsFound++;
                            const data = doc.data();
                            const name = data.employeeName || data.name;
                            const studentShift = data.shift || "á–áŸá‰á˜áŸ‰áŸ„á„";
                            
                            const checkIn = data.checkIn;
                            const checkOut = data.checkOut;

                            if (!checkIn) return; 
                            const checkInStr = String(checkIn).trim();
                            if (checkInStr === "" || checkInStr === "_" || checkInStr === "áˆáº") return;

                            if (checkOut) {
                                const checkOutStr = String(checkOut).trim();
                                if (checkOutStr !== "" && checkOutStr !== "_") { return; }
                            }

                            if (name && !uniqueNames.has(name)) {
                                const dbShiftLower = studentShift.toLowerCase();
                                let isMatch = false;

                                if (dbShiftLower.includes("á–áŸá‰á˜áŸ‰áŸ„á„") || dbShiftLower.includes("full")) { isMatch = true; } 
                                else if (currentShift === "áœáŸá“á–áŸ’ášá¹á€" && (dbShiftLower.includes("á–áŸ’ášá¹á€") || dbShiftLower.includes("morning") || dbShiftLower.includes("á˜á½á™á–áŸ’ášá¹á€"))) { isMatch = true; }
                                else if (currentShift === "áœáŸá“ášáŸáŸ€á›" && (dbShiftLower.includes("ášáŸáŸ€á›") || dbShiftLower.includes("afternoon") || dbShiftLower.includes("á˜á½á™ášáŸáŸ€á›"))) { isMatch = true; }
                                else if (currentShift === "áœáŸá“á™á”áŸ‹" && (dbShiftLower.includes("á™á”áŸ‹") || dbShiftLower.includes("evening") || dbShiftLower.includes("night") || dbShiftLower.includes("á–áŸá›á™á”áŸ‹"))) { isMatch = true; }
                                else if (studentShift === currentShift) { isMatch = true; }

                                if (isMatch) {
                                    uniqueNames.add(name);
                                    fetchedStudents.push({ 
                                        id: doc.id, 
                                        name: name, 
                                        gender: data.gender || 'N/A', 
                                        shift: studentShift,
                                        department: data.department || 'N/A',
                                        group: data.group || data.Group || 'N/A' 
                                    });
                                }
                            }
                        });

                        if (fetchedStudents.length > 0) {
                            setAllStudents(fetchedStudents); 
                            setUseDemoData(false);
                            setDebugInfo(`ášá€áƒá¾á‰ ${fetchedStudents.length} á“á¶á€áŸ‹ (á€áŸ†á–á»á„á˜á¶á“áœááŸ’áá˜á¶á“)áŸ”`);
                        } else {
                            console.warn(`No active students found.`);
                            let msg = "";
                            if (totalRecordsFound > 0) {
                                msg = `á˜á¶á“á‘á·á“áŸ’á“á“áŸá™ááŸ’á„áŸƒá“áŸáŸ‡ (${totalRecordsFound}) á”áŸ‰á»á“áŸ’ááŸ‚á”áŸ’ášá áŸ‚á›á‡á¶á–á½á€á‚áŸ "CheckOut" á¢áŸáŸ‹á á¾á™ á¬ "áˆáº" á¬áá»áŸáœáŸá“áŸ”`;
                            } else {
                                msg = `á˜á·á“á˜á¶á“á‘á·á“áŸ’á“á“áŸá™áŸá˜áŸ’ášá¶á”áŸ‹ááŸ’á„áŸƒá“áŸáŸ‡ (${todayStr}) á‘áŸáŸ”`;
                            }
                            setError(msg);
                            setAllStudents([]);
                            setUseDemoData(false);
                        }

                    } catch (err) {
                        console.error("Firestore Error:", err);
                        let errorMsg = "á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá—áŸ’á‡á¶á”áŸ‹áŸ”";
                        if (err.code === 'permission-denied') errorMsg = "á‚áŸ’á˜á¶á“áŸá·á‘áŸ’á’á· (Permission Denied)áŸ”";
                        else if (err.code === 'failed-precondition') errorMsg = "ááŸ’ášá¼áœá€á¶ášá”á„áŸ’á€á¾á IndexáŸ”";
                        setError(errorMsg);
                        setAllStudents([]); 
                        setUseDemoData(false);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchStudents();
            }, []);

            const handleSpin = () => {
                if (playableStudents.length === 0 || isSpinning) return;

                setIsSpinning(true);
                setWinner(null);
                setSendingTelegram(false);
                setManualSendVisible(false);
                let counter = 0;
                
                const calculatedSpins = playableStudents.length * 3;
                const totalSpins = calculatedSpins > 60 ? calculatedSpins : 60;
                const speed = 50; 

                if (intervalRef.current) clearInterval(intervalRef.current);

                intervalRef.current = setInterval(() => {
                    const randomIndex = Math.floor(Math.random() * playableStudents.length);
                    setCurrentName(playableStudents[randomIndex].name);
                    counter++;

                    if (counter >= totalSpins) {
                        clearInterval(intervalRef.current);
                        finishSpin(playableStudents[randomIndex]);
                    }
                }, speed);
            };

            const finishSpin = async (selectedStudent) => {
                setIsSpinning(false);
                setWinner(selectedStudent);
                setCurrentName(selectedStudent.name);
                
                if (autoSendTelegram) {
                    await sendToTelegram(selectedStudent);
                } else {
                    setManualSendVisible(true);
                }
            };

            // --- VIEW LIST LOGIC (Local Filters for Modal) ---
            const getFilteredViewList = () => {
                return allStudents.filter(s => {
                    const matchesSearch = s.name.toLowerCase().includes(studentSearchTerm.toLowerCase());
                    
                    // Dept Filter
                    let matchesDept = true;
                    const sDept = (s.department || '').toLowerCase().trim();
                    if (listFilterDept === 'Training') matchesDept = sDept.includes('training');
                    else if (listFilterDept === 'Gen2') matchesDept = sDept.includes('á‡áŸ†á“á¶á“áŸ‹áŸ¢') || sDept.includes('gen2');
                    else if (listFilterDept === 'Assistant') matchesDept = sDept.includes('á‡áŸ†á“á½á™á€á¶áš_á›áŸ„á€á‚áŸ’ášá¼áŠá¶ášáŸ‰á¼'); 

                    let matchesGroup = true;
                    const groupRaw = (s.group || '').toLowerCase() + " " + (s.department || '').toLowerCase();
                    const sGroupNormalized = groupRaw.replace(/[\s_-]+/g, ''); 
                    
                    if (listFilterGroup === 'IT') matchesGroup = sGroupNormalized.includes('itsupport');
                    else if (listFilterGroup === 'DRB') matchesGroup = sGroupNormalized.includes('drb');

                    return matchesSearch && matchesDept && matchesGroup;
                });
            };

            const displayedStudents = getFilteredViewList();

            const renderStudentListItem = (student) => {
                const isExcluded = excludedNames.includes(student.name);
                return (
                    <div key={student.name} className="flex items-center justify-between bg-slate-700/50 p-3 rounded-lg border border-slate-600/50">
                        <div className="flex items-center gap-3">
                            <div className={`w-8 h-8 rounded-full flex items-center justify-center ${isExcluded ? 'bg-slate-600 text-slate-400' : 'bg-indigo-500/20 text-indigo-300'}`}>
                                <UserCircle className="w-5 h-5" />
                            </div>
                            <div className="flex flex-col">
                                <span className={`text-sm font-medium ${isExcluded ? 'text-slate-400 line-through' : 'text-white'}`}>
                                    {student.name}
                                </span>
                                <span className="text-[10px] text-slate-400">
                                    {student.group} â€¢ {student.department}
                                </span>
                            </div>
                        </div>
                        <button 
                            onClick={() => toggleStudentExclusion(student.name)}
                            className={`w-10 h-6 rounded-full p-1 transition-colors duration-200 ease-in-out relative ${!isExcluded ? 'bg-green-500' : 'bg-slate-600'}`}
                        >
                            <div className={`bg-white w-4 h-4 rounded-full shadow-sm transform duration-200 ease-in-out ${!isExcluded ? 'translate-x-4' : 'translate-x-0'}`}></div>
                        </button>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-slate-900 text-slate-100 flex items-center justify-center p-4 relative font-sans">
                    
                    {/* Student List Modal */}
                    {showStudentList && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4">
                            <div className="bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-md h-[85vh] flex flex-col relative animate-in zoom-in-95 duration-200">
                                <div className="p-4 border-b border-slate-700 flex items-center justify-between bg-slate-800 rounded-t-2xl z-10">
                                    <h2 className="text-lg font-bold text-white flex items-center gap-2">
                                        <UserCog className="w-5 h-5 text-indigo-400" />
                                        á”á‰áŸ’á‡á¸áˆáŸ’á˜áŸ„áŸ‡ ({displayedStudents.length}/{allStudents.length})
                                    </h2>
                                    <button onClick={() => setShowStudentList(false)} className="text-slate-400 hover:text-white p-1">
                                        <X className="w-6 h-6" />
                                    </button>
                                </div>
                                
                                <div className="p-3 bg-slate-800/95 sticky top-0 z-10 border-b border-slate-700/50 space-y-3">
                                    {/* Search */}
                                    <div className="relative">
                                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400" />
                                        <input 
                                            type="text" 
                                            placeholder="áŸáŸ’áœáŸ‚á„ášá€áˆáŸ’á˜áŸ„áŸ‡..." 
                                            value={studentSearchTerm}
                                            onChange={(e) => setStudentSearchTerm(e.target.value)}
                                            className="w-full bg-slate-900 border border-slate-600 rounded-lg py-2 pl-9 pr-4 text-sm text-white focus:outline-none focus:border-indigo-500"
                                        />
                                    </div>

                                    {/* Filters Bar */}
                                    <div className="flex flex-col gap-2">
                                        <div className="flex items-center gap-2 overflow-x-auto pb-1 no-scrollbar">
                                            <span className="text-[10px] text-slate-400 whitespace-nowrap flex items-center gap-1"><Briefcase className="w-3 h-3"/> á•áŸ’á“áŸ‚á€:</span>
                                            <button onClick={() => setListFilterDept('All')} className={`px-2 py-1 rounded text-[10px] whitespace-nowrap border ${listFilterDept === 'All' ? 'bg-indigo-600 border-indigo-600 text-white' : 'border-slate-600 text-slate-300'}`}>á‘á¶áŸ†á„á¢áŸáŸ‹</button>
                                            <button onClick={() => setListFilterDept('Training')} className={`px-2 py-1 rounded text-[10px] whitespace-nowrap border ${listFilterDept === 'Training' ? 'bg-orange-600 border-orange-600 text-white' : 'border-slate-600 text-slate-300'}`}>Training</button>
                                            <button onClick={() => setListFilterDept('Gen2')} className={`px-2 py-1 rounded text-[10px] whitespace-nowrap border ${listFilterDept === 'Gen2' ? 'bg-orange-600 border-orange-600 text-white' : 'border-slate-600 text-slate-300'}`}>IT á‡áŸ†á“á¶á“áŸ‹áŸ¢</button>
                                            <button onClick={() => setListFilterDept('Assistant')} className={`px-2 py-1 rounded text-[10px] whitespace-nowrap border ${listFilterDept === 'Assistant' ? 'bg-orange-600 border-orange-600 text-white' : 'border-slate-600 text-slate-300'}`}>á‡áŸ†á“á½á™á€á¶áš</button>
                                        </div>
                                        <div className="flex items-center gap-2 overflow-x-auto pb-1 no-scrollbar">
                                            <span className="text-[10px] text-slate-400 whitespace-nowrap flex items-center gap-1"><UsersIcon className="w-3 h-3"/> á€áŸ’ášá»á˜:</span>
                                            <button onClick={() => setListFilterGroup('All')} className={`px-2 py-1 rounded text-[10px] whitespace-nowrap border ${listFilterGroup === 'All' ? 'bg-indigo-600 border-indigo-600 text-white' : 'border-slate-600 text-slate-300'}`}>á‘á¶áŸ†á„á¢áŸáŸ‹</button>
                                            <button onClick={() => setListFilterGroup('IT')} className={`px-2 py-1 rounded text-[10px] whitespace-nowrap border ${listFilterGroup === 'IT' ? 'bg-cyan-600 border-cyan-600 text-white' : 'border-slate-600 text-slate-300'}`}>IT Support</button>
                                            <button onClick={() => setListFilterGroup('DRB')} className={`px-2 py-1 rounded text-[10px] whitespace-nowrap border ${listFilterGroup === 'DRB' ? 'bg-cyan-600 border-cyan-600 text-white' : 'border-slate-600 text-slate-300'}`}>DRB</button>
                                        </div>
                                    </div>

                                    {/* NEW: Toggle All Visible Buttons */}
                                    <div className="flex gap-2 pt-2 border-t border-slate-700/50 mt-2">
                                        <button
                                            onClick={() => toggleAllVisible(true)}
                                            className="flex-1 bg-green-600/20 hover:bg-green-600/30 text-green-400 text-xs py-2 rounded-lg flex items-center justify-center gap-2 transition-colors border border-green-600/30"
                                        >
                                            <CheckSquare className="w-3 h-3" /> á”á¾á€á‘á¶áŸ†á„á¢áŸáŸ‹ ({displayedStudents.length})
                                        </button>
                                        <button
                                            onClick={() => toggleAllVisible(false)}
                                            className="flex-1 bg-red-600/20 hover:bg-red-600/30 text-red-400 text-xs py-2 rounded-lg flex items-center justify-center gap-2 transition-colors border border-red-600/30"
                                        >
                                            <Square className="w-3 h-3" /> á”á·á‘á‘á¶áŸ†á„á¢áŸáŸ‹ ({displayedStudents.length})
                                        </button>
                                    </div>
                                </div>

                                <div className="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar">
                                    {displayedStudents.length > 0 ? (
                                        displayedStudents.map(renderStudentListItem)
                                    ) : (
                                        <div className="text-center text-slate-500 py-10 flex flex-col items-center gap-2">
                                            <ListFilter className="w-10 h-10 opacity-20" />
                                            <span>ášá€á˜á·á“áƒá¾á‰áˆáŸ’á˜áŸ„áŸ‡áá¶á˜á›á€áŸ’ááááŸ’áŒ</span>
                                        </div>
                                    )}
                                </div>
                                
                                <div className="p-4 border-t border-slate-700 bg-slate-800 rounded-b-2xl">
                                    <div className="flex justify-between text-xs text-slate-400 mb-3">
                                        <span>á”á·á‘ (Excluded): {excludedNames.length}</span>
                                        <span>á”á¾á€ (Active): {allStudents.length - excludedNames.length}</span>
                                    </div>
                                    <button onClick={() => setShowStudentList(false)} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-all">
                                        ášá½á…ášá¶á›áŸ‹
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 z-50 overflow-y-auto bg-black/60 backdrop-blur-sm">
                            <div className="flex min-h-full items-center justify-center p-4">
                                <div className="bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-md p-6 relative animate-in zoom-in-95 duration-200 flex flex-col max-h-[90vh]">
                                    <button 
                                        onClick={() => setShowSettings(false)}
                                        className="absolute top-4 right-4 text-slate-400 hover:text-white transition-colors z-10"
                                    >
                                        <X className="w-6 h-6" />
                                    </button>
                                    
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-xl font-bold text-white flex items-center gap-2">
                                            <Settings className="w-6 h-6 text-indigo-400" />
                                            á€á¶ášá€áŸ†áááŸ‹
                                        </h2>
                                    </div>

                                    {/* Tab Navigation */}
                                    <div className="flex border-b border-slate-700 mb-4">
                                        <button 
                                            onClick={() => setSettingsTab('general')}
                                            className={`flex-1 pb-2 text-sm font-medium transition-colors border-b-2 ${settingsTab === 'general' ? 'border-indigo-500 text-white' : 'border-transparent text-slate-400 hover:text-slate-200'}`}
                                        >
                                            á‘á¼á‘áŸ…
                                        </button>
                                        <button 
                                            onClick={() => setSettingsTab('history')}
                                            className={`flex-1 pb-2 text-sm font-medium transition-colors border-b-2 flex items-center justify-center gap-2 ${settingsTab === 'history' ? 'border-indigo-500 text-white' : 'border-transparent text-slate-400 hover:text-slate-200'}`}
                                        >
                                            <History className="w-4 h-4" /> á”áŸ’ášáœááŸ’áá· ({historyData.length})
                                        </button>
                                    </div>
                                    
                                    <div className="flex-1 overflow-y-auto custom-scrollbar pr-2 space-y-6">
                                        
                                        {/* GENERAL SETTINGS TAB */}
                                        {settingsTab === 'general' && (
                                            <>
                                                {/* Student List Button */}
                                                <div className="bg-indigo-600/10 border border-indigo-500/30 rounded-xl p-4 flex items-center justify-between">
                                                    <div className="flex items-center gap-3">
                                                        <div className="bg-indigo-500/20 p-2 rounded-full">
                                                            <UserCog className="w-5 h-5 text-indigo-400" />
                                                        </div>
                                                        <div className="flex flex-col">
                                                            <span className="text-sm font-semibold text-white">á”á‰áŸ’á‡á¸áˆáŸ’á˜áŸ„áŸ‡áŸá·áŸáŸ’áŸ</span>
                                                            <span className="text-xs text-indigo-300">á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á€á¶ášá”á·á‘/á”á¾á€áˆáŸ’á˜áŸ„áŸ‡</span>
                                                        </div>
                                                    </div>
                                                    <button 
                                                        onClick={() => setShowStudentList(true)}
                                                        className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold rounded-lg transition-colors flex items-center gap-1"
                                                    >
                                                        á”á¾á€á˜á¾á› <Users className="w-3 h-3" />
                                                    </button>
                                                </div>

                                                {/* Telegram Config */}
                                                <div className="space-y-3 pb-4 border-b border-slate-700">
                                                    <div className="flex items-center gap-2 text-slate-300 mb-2">
                                                        <Cloud className="w-4 h-4 text-blue-400" />
                                                        <h3 className="text-sm font-semibold">á€á¶ášá—áŸ’á‡á¶á”áŸ‹ Telegram</h3>
                                                    </div>
                                                    
                                                    {/* Bot Token Input */}
                                                    <div>
                                                        <label className="block text-slate-400 text-xs mb-1 flex items-center gap-2">
                                                            Bot Token <Lock className="w-3 h-3 text-green-400" />
                                                        </label>
                                                        <div className="relative">
                                                            <input 
                                                                type={showBotToken ? "text" : "password"}
                                                                value={botToken}
                                                                onChange={(e) => setBotToken(e.target.value)}
                                                                placeholder="Ex: 7048123456:AAGq..."
                                                                className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 pr-10 text-white focus:outline-none focus:border-indigo-500 text-sm font-mono no-select"
                                                                autoComplete="off"
                                                                onCopy={(e) => e.preventDefault()}
                                                                onCut={(e) => e.preventDefault()}
                                                            />
                                                            <button
                                                                type="button"
                                                                onClick={() => setShowBotToken(!showBotToken)}
                                                                className="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-white"
                                                            >
                                                                {showBotToken ? <EyeOff className="w-4 h-4" /> : <Eye className="w-4 h-4" />}
                                                            </button>
                                                        </div>
                                                    </div>

                                                    {/* Channel List */}
                                                    <div className="space-y-2">
                                                        <div className="flex items-center justify-between">
                                                            <label className="block text-slate-400 text-xs">Chat IDs / Channels</label>
                                                            <button 
                                                                onClick={addChannel}
                                                                className="text-xs text-indigo-400 hover:text-indigo-300 flex items-center gap-1"
                                                            >
                                                                <Plus className="w-3 h-3" /> á”á“áŸ’ááŸ‚á˜ááŸ’á˜á¸
                                                            </button>
                                                        </div>

                                                        {telegramChannels.map((channel, index) => (
                                                            <div key={channel.id} className="bg-slate-900/50 p-3 rounded-lg border border-slate-700 space-y-2">
                                                                <div className="flex items-center justify-between gap-2">
                                                                    <input 
                                                                        type="text"
                                                                        value={channel.name}
                                                                        onChange={(e) => updateChannel(channel.id, 'name', e.target.value)}
                                                                        placeholder="áˆáŸ’á˜áŸ„áŸ‡ (á§. Group IT)"
                                                                        className="flex-1 bg-transparent border-b border-slate-600 text-xs text-white placeholder-slate-500 focus:outline-none focus:border-indigo-500 py-1"
                                                                    />
                                                                    <div className="flex items-center gap-2">
                                                                        <button 
                                                                            onClick={() => toggleChannelActive(channel.id)}
                                                                            className={`p-1.5 rounded-md transition-colors ${channel.active ? 'bg-green-500/20 text-green-400' : 'bg-slate-700 text-slate-500'}`}
                                                                            title={channel.active ? "á€áŸ†á–á»á„á”á¾á€" : "á€áŸ†á–á»á„á”á·á‘"}
                                                                        >
                                                                            <Power className="w-3.5 h-3.5" />
                                                                        </button>
                                                                        <button 
                                                                            onClick={() => removeChannel(channel.id)}
                                                                            className="p-1.5 rounded-md hover:bg-red-500/20 text-slate-500 hover:text-red-400 transition-colors"
                                                                        >
                                                                            <Trash2 className="w-3.5 h-3.5" />
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                <input 
                                                                    type="text"
                                                                    value={channel.chatId}
                                                                    onChange={(e) => updateChannel(channel.id, 'chatId', e.target.value)}
                                                                    placeholder="Chat ID (Ex: -100...)"
                                                                    className="w-full bg-slate-800 border border-slate-600 rounded px-2 py-1.5 text-xs font-mono text-slate-300 focus:outline-none focus:border-indigo-500"
                                                                />
                                                            </div>
                                                        ))}
                                                        
                                                        {telegramChannels.length === 0 && (
                                                            <div className="text-center text-xs text-slate-500 py-2 border border-dashed border-slate-700 rounded-lg">
                                                                á˜á·á“á‘á¶á“áŸ‹á˜á¶á“ Chat ID á“áŸ…á¡á¾á™áŸ”
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>

                                                {/* General Toggles */}
                                                <div className="space-y-4 border-b border-slate-700 pb-4">
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex flex-col">
                                                            <span className="text-sm text-white font-medium">á•áŸ’á‰á¾áŸá¶ášáŸáŸ’áœáŸá™á”áŸ’ášáœááŸ’áá·</span>
                                                            <span className="text-xs text-slate-400">á•áŸ’á‰á¾á‘áŸ… Telegram á—áŸ’á›á¶á˜áŸ—</span>
                                                        </div>
                                                        <button onClick={toggleAutoSend} className={`w-12 h-6 rounded-full p-1 transition-colors ${autoSendTelegram ? 'bg-indigo-500' : 'bg-slate-600'}`}>
                                                            <div className={`bg-white w-4 h-4 rounded-full shadow-md transform duration-200 ${autoSendTelegram ? 'translate-x-6' : 'translate-x-0'}`}></div>
                                                        </button>
                                                    </div>

                                                    <div className="flex items-center justify-between">
                                                        <div className="flex flex-col">
                                                            <span className="text-sm text-white font-medium">á áŸ…ááŸ‚áˆáŸ’á˜áŸ„áŸ‡ááŸ’á˜á¸ (Unique)</span>
                                                            <span className="text-xs text-slate-400">á˜á·á“á áŸ…áˆáŸ’á˜áŸ„áŸ‡áŠáŠáŸ‚á›á€áŸ’á“á»á„ááŸ’á„áŸƒá“áŸáŸ‡</span>
                                                        </div>
                                                        <button onClick={toggleFilterUnique} className={`w-12 h-6 rounded-full p-1 transition-colors ${filterUniqueWinners ? 'bg-indigo-500' : 'bg-slate-600'}`}>
                                                            <div className={`bg-white w-4 h-4 rounded-full shadow-md transform duration-200 ${filterUniqueWinners ? 'translate-x-6' : 'translate-x-0'}`}></div>
                                                        </button>
                                                    </div>
                                                    
                                                    {filterUniqueWinners && todaysWinners.length > 0 && (
                                                        <div className="flex justify-between items-center bg-slate-900/50 p-2 rounded-lg">
                                                            <span className="text-xs text-slate-400">á”á¶á“á áŸ…: {todaysWinners.length} á“á¶á€áŸ‹</span>
                                                            <button 
                                                                onClick={handleClearWinners} 
                                                                className={`text-xs flex items-center gap-1 px-2 py-1 rounded transition-colors ${confirmResetWinners ? 'bg-red-600 text-white animate-pulse' : 'text-red-400 hover:text-red-300 hover:bg-red-500/10'}`}
                                                            >
                                                                <RotateCcw className="w-3 h-3" /> {confirmResetWinners ? "á…áŸ’á”á¶áŸáŸ‹á‘áŸ?" : "Reset"}
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>

                                                {/* Department Filter Section */}
                                                <div className="space-y-3 pb-4 border-b border-slate-700">
                                                    <div className="flex items-center gap-2 text-slate-300">
                                                        <Briefcase className="w-4 h-4 text-orange-400" />
                                                        <h3 className="text-sm font-semibold">Filter áá¶á˜á•áŸ’á“áŸ‚á€á€á¶ášá„á¶áš (Department)</h3>
                                                    </div>
                                                    <div className="space-y-2 pl-2">
                                                        <div className="flex items-center justify-between">
                                                            <span className="text-xs text-slate-300">Training_á‡áŸ†á“á½á™á€á¶ášá›áŸ„á€á‚áŸ’ášá¼áŠá¶ášáŸ‰á¼</span>
                                                            <button onClick={toggleDeptTraining} className={`w-10 h-5 rounded-full p-0.5 transition-colors ${filterDeptTraining ? 'bg-orange-500' : 'bg-slate-600'}`}>
                                                                <div className={`bg-white w-4 h-4 rounded-full shadow-md transform duration-200 ${filterDeptTraining ? 'translate-x-5' : 'translate-x-0'}`}></div>
                                                            </button>
                                                        </div>
                                                        <div className="flex items-center justify-between">
                                                            <span className="text-xs text-slate-300">ášáŸ€á“áœá‚áŸ’á‚á”ááŸ’áŠá»áŸ‡á”ááŸ’áŠá¶á›IT_á‡áŸ†á“á¶á“áŸ‹áŸ¢</span>
                                                            <button onClick={toggleDeptITGen2} className={`w-10 h-5 rounded-full p-0.5 transition-colors ${filterDeptITGen2 ? 'bg-orange-500' : 'bg-slate-600'}`}>
                                                                <div className={`bg-white w-4 h-4 rounded-full shadow-md transform duration-200 ${filterDeptITGen2 ? 'translate-x-5' : 'translate-x-0'}`}></div>
                                                            </button>
                                                        </div>
                                                        <div className="flex items-center justify-between">
                                                            <span className="text-xs text-slate-300">á‡áŸ†á“á½á™á€á¶áš_á›áŸ„á€á‚áŸ’ášá¼áŠá¶ášáŸ‰á¼</span>
                                                            <button onClick={toggleDeptAssistant} className={`w-10 h-5 rounded-full p-0.5 transition-colors ${filterDeptAssistant ? 'bg-orange-500' : 'bg-slate-600'}`}>
                                                                <div className={`bg-white w-4 h-4 rounded-full shadow-md transform duration-200 ${filterDeptAssistant ? 'translate-x-5' : 'translate-x-0'}`}></div>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Group Filter Section */}
                                                <div className="space-y-3">
                                                    <div className="flex items-center gap-2 text-slate-300">
                                                        <UsersIcon className="w-4 h-4 text-cyan-400" />
                                                        <h3 className="text-sm font-semibold">Filter áá¶á˜á€áŸ’ášá»á˜ (Group)</h3>
                                                    </div>
                                                    <div className="space-y-2 pl-2">
                                                        <div className="flex items-center justify-between">
                                                            <span className="text-xs text-slate-300">IT Support</span>
                                                            <button onClick={toggleGroupITSupport} className={`w-10 h-5 rounded-full p-0.5 transition-colors ${filterGroupITSupport ? 'bg-cyan-500' : 'bg-slate-600'}`}>
                                                                <div className={`bg-white w-4 h-4 rounded-full shadow-md transform duration-200 ${filterGroupITSupport ? 'translate-x-5' : 'translate-x-0'}`}></div>
                                                            </button>
                                                        </div>
                                                        <div className="flex items-center justify-between">
                                                            <span className="text-xs text-slate-300">DRB</span>
                                                            <button onClick={toggleGroupDRB} className={`w-10 h-5 rounded-full p-0.5 transition-colors ${filterGroupDRB ? 'bg-cyan-500' : 'bg-slate-600'}`}>
                                                                <div className={`bg-white w-4 h-4 rounded-full shadow-md transform duration-200 ${filterGroupDRB ? 'translate-x-5' : 'translate-x-0'}`}></div>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </>
                                        )}

                                        {/* HISTORY TAB */}
                                        {settingsTab === 'history' && (
                                            <div className="space-y-4">
                                                <div className="flex items-center justify-between mb-2">
                                                    <span className="text-xs text-slate-400">á”á„áŸ’á á¶á‰ {historyData.length} á“á¶á€áŸ‹á…á»á„á€áŸ’ášáŸ„á™ (áŸ¡ááŸ‚)</span>
                                                    {historyData.length > 0 && (
                                                        <button 
                                                            onClick={handleClearHistory}
                                                            className={`text-xs flex items-center gap-1 px-2 py-1 rounded transition-colors ${confirmResetHistory ? 'bg-red-600 text-white animate-pulse' : 'text-red-400 hover:text-red-300 bg-red-500/10'}`}
                                                        >
                                                            <Trash2 className="w-3 h-3" /> {confirmResetHistory ? "á›á»á”á‘á¶áŸ†á„á¢áŸáŸ‹?" : "á›á»á”á‘á¶áŸ†á„á¢áŸáŸ‹"}
                                                        </button>
                                                    )}
                                                </div>

                                                {historyData.length === 0 ? (
                                                    <div className="text-center text-slate-500 py-10 flex flex-col items-center gap-2 border border-dashed border-slate-700 rounded-xl">
                                                        <FileClock className="w-10 h-10 opacity-20" />
                                                        <span>á˜á·á“á‘á¶á“áŸ‹á˜á¶á“á”áŸ’ášáœááŸ’áá·á áŸ…á“áŸ…á¡á¾á™</span>
                                                    </div>
                                                ) : (
                                                    <div className="space-y-2">
                                                        {historyData.map((item, idx) => (
                                                            <div key={idx} className="bg-slate-900/50 p-3 rounded-lg border border-slate-700 flex flex-col gap-1">
                                                                <div className="flex justify-between items-start">
                                                                    <div className="flex items-center gap-2">
                                                                        <span className="text-lg">{item.icon}</span>
                                                                        <span className="font-bold text-white">{item.name}</span>
                                                                    </div>
                                                                    <span className="text-[10px] text-slate-500 font-mono">
                                                                        {formatDateTime(item.timestamp)}
                                                                    </span>
                                                                </div>
                                                                {item.message && (
                                                                    <div className="text-xs text-slate-400 bg-black/20 p-2 rounded mt-1 italic border-l-2 border-indigo-500/50">
                                                                        "{item.message.trim()}"
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                        
                                        {settingsTab === 'general' && (
                                            <button 
                                                onClick={handleSaveSettingsButton}
                                                disabled={isSaving}
                                                className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition-all mt-4 disabled:opacity-50"
                                            >
                                                {isSaving ? <RefreshCw className="w-5 h-5 animate-spin" /> : <Save className="w-5 h-5" />}
                                                {isSaving ? "á€áŸ†á–á»á„ášá€áŸ’áŸá¶á‘á»á€..." : "á”á·á‘ Settings"}
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="bg-white/10 backdrop-blur-md rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden border border-white/20">
                        
                        {/* Header */}
                        <div className="bg-indigo-600/80 p-6 text-center relative">
                            <h1 className="text-2xl md:text-3xl font-bold text-white flex items-center justify-center gap-3 drop-shadow-md">
                                <Database className="w-8 h-8" />
                                <span>Random Student Picker</span>
                            </h1>
                            
                            <div className="flex justify-center gap-3 mt-4 flex-wrap">
                                <div className="bg-black/30 px-3 py-1 rounded-full text-xs flex items-center gap-2 border border-white/10">
                                    <Calendar className="w-3 h-3 text-indigo-300" />
                                    <span>{getTodayDateStr()}</span>
                                </div>
                                <div className="bg-black/30 px-3 py-1 rounded-full text-xs flex items-center gap-2 border border-white/10">
                                    <Clock className="w-3 h-3 text-pink-300" />
                                    <span>{getCurrentShift()}</span>
                                </div>
                            </div>

                            <div className="absolute top-5 right-5">
                                {loading ? (
                                    <div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                                ) : (
                                    <div className={`h-3 w-3 rounded-full shadow-lg border border-white/50 ${allStudents.length > 0 ? 'bg-green-400' : 'bg-red-500'}`} 
                                            title={allStudents.length > 0 ? "Online Mode" : "No Data"}></div>
                                )}
                            </div>
                        </div>

                        {/* Content */}
                        <div className="p-8 flex flex-col items-center">
                            
                            <div className={`
                                relative w-full aspect-video rounded-2xl flex flex-col items-center justify-center mb-6 transition-all duration-500
                                ${winner 
                                    ? 'bg-gradient-to-tr from-green-500 to-emerald-600 scale-105 shadow-[0_0_40px_rgba(16,185,129,0.5)] border-2 border-white/30' 
                                    : 'bg-white/5 shadow-inner border border-white/10'
                                }
                            `}>
                                {winner && (
                                    <div className="absolute -top-8 animate-bounce z-10">
                                        <Trophy className="w-16 h-16 text-yellow-400 drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)]" />
                                    </div>
                                )}
                                
                                <UserCircle className={`w-20 h-20 mb-4 transition-colors duration-300 ${winner ? 'text-white' : 'text-white/20'}`} />
                                
                                <h2 className={`text-4xl md:text-5xl font-bold text-center transition-all duration-300 ${winner ? 'text-white scale-110 drop-shadow-md' : 'text-white/50'}`}>
                                    {currentName}
                                </h2>
                                
                                {winner && (
                                    <div className="mt-4 text-center animate-pulse flex flex-col items-center gap-2">
                                        <span className="bg-white/20 px-4 py-1 rounded-full text-sm font-medium">
                                            áœáŸá“: {winner.shift}
                                        </span>
                                        {/* Status Text for Telegram */}
                                        {autoSendTelegram && botToken && (
                                            <span className="text-xs text-blue-300 flex items-center gap-1">
                                                <Send className="w-3 h-3" />
                                                {sendingTelegram ? "á€áŸ†á–á»á„á•áŸ’á‰á¾..." : "á”á¶á“á•áŸ’á‰á¾áŸáŸ’áœáŸá™á”áŸ’ášáœááŸ’áá·"}
                                            </span>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Manual Send Button */}
                            {winner && manualSendVisible && (
                                <button
                                    onClick={() => sendToTelegram(winner)}
                                    disabled={sendingTelegram}
                                    className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 shadow-lg mb-4 transition-all animate-bounce-short"
                                >
                                    <Send className="w-5 h-5" />
                                    {sendingTelegram ? "á€áŸ†á–á»á„á•áŸ’á‰á¾..." : "á•áŸ’á‰á¾áŸá¶ášá‘áŸ… Telegram"}
                                </button>
                            )}

                            <button
                                onClick={handleSpin}
                                disabled={isSpinning || loading || playableStudents.length === 0}
                                className={`
                                    w-full py-4 px-8 rounded-xl text-xl font-bold text-white shadow-xl transform transition-all duration-200 active:scale-95 flex items-center justify-center gap-3 border border-white/20 mb-6
                                    ${isSpinning || playableStudents.length === 0
                                        ? 'bg-slate-600/50 cursor-not-allowed opacity-70' 
                                        : 'bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-400 hover:to-purple-500 hover:shadow-indigo-500/40'
                                    }
                                `}
                            >
                                {isSpinning ? (
                                    <>
                                        <RefreshCw className="w-6 h-6 animate-spin" />
                                        á€áŸ†á–á»á„á…á¶á”áŸ‹áˆáŸ’á˜áŸ„áŸ‡...
                                    </>
                                ) : (
                                    <>
                                        <Shuffle className="w-6 h-6" />
                                        {winner ? 'á…á¶á”áŸ‹áˆáŸ’á˜áŸ„áŸ‡á˜áŸ’áá„á‘áŸ€á' : 'á…á¶á”áŸ‹á•áŸ’áá¾á˜á áŸ…áˆáŸ’á˜áŸ„áŸ‡'}
                                    </>
                                )}
                            </button>

                            {/* Custom Message Input */}
                            <div className="w-full relative mb-6">
                                <label className="text-xs text-slate-400 mb-2 block flex items-center gap-1">
                                    <MessageSquare className="w-3 h-3" />
                                    áŸá¶ášá—áŸ’á‡á¶á”áŸ‹á‡á¶á˜á½á™áˆáŸ’á˜áŸ„áŸ‡ (Cloud Sync)
                                </label>
                                <input 
                                    type="text" 
                                    value={customMessage}
                                    onChange={(e) => setCustomMessage(e.target.value)}
                                    onBlur={handleMessageBlur}
                                    placeholder="á§á‘á¶á ášááŸ: áŸá¼á˜á˜á€á‘á‘á½á›ášá„áŸ’áœá¶á“áŸ‹..."
                                    className="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-white placeholder-slate-500 focus:outline-none focus:border-indigo-500 transition-colors text-sm"
                                />
                            </div>

                            <div className="mt-2 w-full space-y-3 border-t border-white/10 pt-4">
                                <div className="flex justify-between items-center text-slate-400 text-xs font-mono">
                                    <div className="flex flex-col">
                                        <span>Total Active: {allStudents.length}</span>
                                        {(filterUniqueWinners || filterDeptTraining || filterDeptITGen2 || filterGroupITSupport || filterGroupDRB || excludedNames.length > 0) && (
                                            <span className="text-[10px] text-green-400">Playable: {playableStudents.length} (Filter On)</span>
                                        )}
                                    </div>
                                    <button 
                                        onClick={() => setShowSettings(true)}
                                        className="flex items-center gap-1 hover:text-white transition-colors"
                                    >
                                        <span className={`w-2 h-2 rounded-full ${settingsLoaded && botToken ? 'bg-green-500' : 'bg-slate-500'}`}></span>
                                        Settings <Settings className="w-3 h-3" />
                                    </button>
                                </div>
                                
                                {debugInfo && !error && (
                                    <div className="bg-blue-500/10 text-blue-200 text-xs p-3 rounded-lg border border-blue-500/20 flex items-center gap-2">
                                        <CheckCircle2 className="w-4 h-4" />
                                        {debugInfo}
                                    </div>
                                )}

                                {error && (
                                    <div className="bg-red-500/10 text-red-200 text-xs p-3 rounded-lg border border-red-500/20 flex items-start gap-2">
                                        <AlertTriangle className="w-4 h-4 mt-0.5 flex-shrink-0" />
                                        <span>{error}</span>
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        <div className="bg-black/20 p-4 text-center text-slate-500 text-[10px] tracking-wider uppercase">
                            Random Student Picker System â€¢ {new Date().getFullYear()}
                        </div>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<RandomStudentApp />);
    </script>
</body>
</html>
